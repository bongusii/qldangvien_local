<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω ƒê·∫£ng vi√™n</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <style>
        #memberModal, #viewModal, #deleteModal, #helpModal, #authModal { 
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #memberModal.show, #viewModal.show, #deleteModal.show, #helpModal.show, #authModal.show { 
            display: flex;
            opacity: 1;
        }
        #filterMenu {
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        #filterMenu.show {
            display: block;
            opacity: 1;
        }
        #helpModalContent::-webkit-scrollbar {
            width: 8px;
        }
        #helpModalContent::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        #helpModalContent::-webkit-scrollbar-track {
            background-color: #f1f5f9;
        }
        
        #appContainer {
            display: none; /* ·∫®n ban ƒë·∫ßu */
        }
        #appContainer.unlocked {
            display: block; /* Hi·ªán khi ƒë√£ ƒëƒÉng nh·∫≠p */
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8 flex flex-col min-h-screen antialiased">
    
    <div id="authModal" class="fixed inset-0 bg-gray-900 bg-opacity-90 overflow-y-auto h-full w-full items-center justify-center p-4 z-50">
        <div class="relative mx-auto w-full max-w-sm shadow-lg rounded-lg bg-white">
            <div class="p-6">
                <h3 class="text-2xl text-center leading-6 font-bold text-gray-900 mb-4">ƒê√£ kho√°</h3>
                <p class="text-center text-sm text-gray-500 mb-6">Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ m·ªü kho√° d·ªØ li·ªáu. <br>(N·∫øu ƒë√¢y l√† l·∫ßn ƒë·∫ßu, m·∫≠t kh·∫©u b·∫°n nh·∫≠p s·∫Ω l√† m·∫≠t kh·∫©u m·ªõi).</p>
                
                <div class="space-y-4">
                    <div>
                        <label for="passwordInput" class="block text-sm font-medium text-gray-700">M·∫≠t kh·∫©u</label>
                        <input type="password" id="passwordInput" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" autofocus>
                    </div>
                    <button id="loginBtn" class="w-full py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500">
                        M·ªü kho√°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="appContainer">
        <div class="container mx-auto max-w-7xl bg-white shadow-lg rounded-lg p-4 md:p-6 flex-grow">
            
            <h1 class="text-2xl md:text-3xl font-bold text-center text-red-700 mb-6">
                H·ªá th·ªëng Qu·∫£n l√Ω ƒê·∫£ng vi√™n
            </h1>

            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg shadow-sm border border-blue-200">
                    <h3 class="text-sm font-medium text-blue-800">T·ªïng s·ªë ƒê·∫£ng vi√™n</h3>
                    <p id="statTotal" class="text-3xl font-bold text-blue-900">0</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg shadow-sm border border-green-200">
                    <h3 class="text-sm font-medium text-green-800">Nam</h3>
                    <p id="statMale" class="text-3xl font-bold text-green-900">0</p>
                </div>
                <div class="bg-pink-50 p-4 rounded-lg shadow-sm border border-pink-200">
                    <h3 class="text-sm font-medium text-pink-800">N·ªØ</h3>
                    <p id="statFemale" class="text-3xl font-bold text-pink-900">0</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg shadow-sm border border-yellow-200">
                    <h3 class="text-sm font-medium text-yellow-800">S·∫Øp nh·∫≠n Huy hi·ªáu</h3>
                    <p id="statMedal" class="text-3xl font-bold text-yellow-900">0</p>
                </div>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <div class="flex gap-2">
                    <button id="addMemberBtn" class="py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500">
                        + Th√™m ƒê·∫£ng vi√™n
                    </button>
                    <button id="bulkDeleteBtn" class="py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-red-600 text-white hover:bg-red-700 focus:ring-red-500 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        X√≥a m·ª•c ƒë√£ ch·ªçn (0)
                    </button>
                </div>
                
                <div class="flex flex-wrap gap-2 justify-end items-center">
                    <button id="helpBtn" title="Xem H∆∞·ªõng d·∫´n" class="p-2 rounded-full font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-gray-200 text-gray-700 hover:bg-gray-300 focus:ring-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM8.94 6.94a.75.75 0 11-1.06-1.061 3.5 3.5 0 014.59.815.75.75 0 01-1.22.872A2 2 0 009.25 7.75v.25a.75.75 0 01-1.5 0v-.25c0-.553.224-1.054.59-1.41zM9 10a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 019 10z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    
                    <button id="exportBtn" class="text-sm py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-green-600 text-white hover:bg-green-700 focus:ring-green-500">
                        Xu·∫•t JSON
                    </button>
                    <label class="text-sm py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-yellow-500 text-white hover:bg-yellow-600 focus:ring-yellow-400 cursor-pointer">
                        Nh·∫≠p JSON (Restore)
                        <input type="file" id="importInput" class="hidden" accept=".json,.txt">
                    </label>
                    <button id="downloadCsvTemplateBtn" class="text-sm py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-gray-500 text-white hover:bg-gray-600 focus:ring-gray-400">
                        T·∫£i CSV m·∫´u
                    </button>
                    <label class="text-sm py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-cyan-600 text-white hover:bg-cyan-700 focus:ring-cyan-500 cursor-pointer">
                        Nh·∫≠p t·ª´ CSV
                        <input type="file" id="importCsvInput" class="hidden" accept=".csv">
                    </label>
                    <button id="exportCsvBtn" class="text-sm py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-teal-600 text-white hover:bg-teal-700 focus:ring-teal-500">
                        Xu·∫•t ra CSV
                    </button>
                </div>
            </div>


            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm theo T√™n, Qu√™ qu√°n, SƒêT, CCCD..." class="border-gray-300 rounded-md shadow-sm p-2 w-full col-span-1 md:col-span-4">
                
                <div class="relative col-span-1">
                    <button id="filterMenuBtn" class="w-full py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-white text-gray-700 hover:bg-gray-50 border border-gray-300 flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                            <path fill-rule="evenodd" d="M2.628 1.601C5.028 1.206 7.49 1 10 1s4.973.206 7.372.601a.75.75 0 01.628.74v2.288a2.25 2.25 0 01-.659 1.59l-4.682 4.683a2.25 2.25 0 00-.659 1.59v3.037c0 .684-.31 1.33-.844 1.757l-1.937 1.55A.75.75 0 0110 18v-5.964a2.25 2.25 0 00-.659-1.59L4.659 5.77A2.25 2.25 0 014 4.18V2.34a.75.75 0 01.628-.74z" clip-rule="evenodd" />
                        </svg>
                        S·∫Øp x·∫øp & L·ªçc
                    </button>
                    
                    <div id="filterMenu" class="absolute right-0 mt-2 w-72 bg-white border border-gray-200 rounded-lg shadow-xl z-10">
                        <div class="p-4 space-y-4">
                            <div>
                                <h4 class="text-sm font-semibold text-gray-500 uppercase mb-2">S·∫Øp x·∫øp theo</h4>
                                <div class="space-y-1">
                                    <label class="flex items-center gap-2">
                                        <input type="radio" name="sort" value="partyAge_desc" class="form-radio text-blue-600" checked>
                                        <span class="text-sm">Tu·ªïi ƒê·∫£ng (Cao ‚ûî Th·∫•p)</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="radio" name="sort" value="partyAge_asc" class="form-radio text-blue-600">
                                        <span class="text-sm">Tu·ªïi ƒê·∫£ng (Th·∫•p ‚ûî Cao)</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="radio" name="sort" value="name_asc" class="form-radio text-blue-600">
                                        <span class="text-sm">H·ªç t√™n (A ‚ûî Z)</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="radio" name="sort" value="name_desc" class="form-radio text-blue-600">
                                        <span class="text-sm">H·ªç t√™n (Z ‚ûî A)</span>
                                    </label>
                                </div>
                            </div>
                            
                            <hr class="border-gray-200">
                            
                            <div>
                                <h4 class="text-sm font-semibold text-gray-500 uppercase mb-2">L·ªçc theo Gi·ªõi t√≠nh</h4>
                                <div class="space-y-1">
                                    <label class="flex items-center gap-2">
                                        <input type="radio" name="gender" value="all" class="form-radio text-blue-600" checked>
                                        <span class="text-sm">T·∫•t c·∫£</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="radio" name="gender" value="Nam" class="form-radio text-blue-600">
                                        <span class="text-sm">Nam</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="radio" name="gender" value="N·ªØ" class="form-radio text-blue-600">
                                        <span class="text-sm">N·ªØ</span>
                                    </label>
                                </div>
                            </div>
                            
                            <hr class="border-gray-200">
                            
                            <div>
                                <h4 class="text-sm font-semibold text-gray-500 uppercase mb-2">L·ªçc theo Huy hi·ªáu</h4>
                                <div class="space-y-1">
                                    <label class="flex items-center gap-2">
                                        <input type="radio" name="medal" value="all" class="form-radio text-blue-600" checked>
                                        <span class="text-sm">T·∫•t c·∫£</span>
                                    </label>
                                    <label class="flex items-center gap-2">
                                        <input type="radio" name="medal" value="upcoming" class="form-radio text-blue-600">
                                        <span class="text-sm">S·∫Øp nh·∫≠n Huy hi·ªáu</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="overflow-x-auto border border-gray-200 rounded-lg shadow-sm">
                <table class="min-w-full bg-white">
                    <thead class="bg-gray-800 text-white">
                        <tr>
                            <th class="py-3 px-4 border-b border-gray-600 w-12">
                                <input type="checkbox" id="selectAllCheckbox" title="Ch·ªçn t·∫•t c·∫£" class="rounded border-gray-400 text-blue-500 focus:ring-blue-500">
                            </th>
                            <th class="py-3 px-4 border-b border-gray-600 text-center">ID</th>
                            <th class="py-3 px-4 border-b border-gray-600 text-left">H·ªç t√™n</th>
                            <th class="py-3 px-4 border-b border-gray-600 text-center">Tu·ªïi ƒê·∫£ng</th>
                            <th class="py-3 px-4 border-b border-gray-600 text-center">Huy hi·ªáu s·∫Øp t·ªõi</th>
                            <th class="py-3 px-4 border-b border-gray-600 text-center">Tr·∫°ng th√°i</th>
                            <th class="py-3 px-4 border-b border-gray-600 text-center">H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="memberTableBody">
                        </tbody>
                </table>
            </div>

            <div class="flex flex-col md:flex-row justify-between items-center gap-4 mt-6">
                <div>
                    <select id="itemsPerPageSelect" class="border-gray-300 rounded-md shadow-sm p-2 text-sm">
                        <option value="10">Hi·ªÉn th·ªã 10/trang</option>
                        <option value="20">Hi·ªÉn th·ªã 20/trang</option>
                        <option value="50">Hi·ªÉn th·ªã 50/trang</option>
                        <option value="100">Hi·ªÉn th·ªã 100/trang</option>
                    </select>
                </div>
                <div id="paginationControls" class="flex justify-center items-center gap-1">
                </div>
            </div>


        </div>

        <footer class="text-center text-gray-500 text-sm mt-8 py-4">
            H·ªá th·ªëng Qu·∫£n l√Ω ƒê·∫£ng vi√™n (Local) &copy; 2025 - Ph√°t tri·ªÉn b·ªüi Phan Ho√†ng Anh
        </footer>
    </div>


    <div id="viewModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center p-4">
        <div class="relative mx-auto w-full max-w-2xl shadow-lg rounded-lg bg-white">
            <div class="p-6">
                <h3 class="text-2xl text-center leading-6 font-bold text-gray-900 mb-6" id="viewModalTitle">Chi ti·∫øt ƒê·∫£ng vi√™n</h3>
                
                <div id="viewModalContent" class="mt-2 text-left space-y-6 max-h-[70vh] overflow-y-auto pr-2">
                    </div>

                <div class="items-center px-4 py-3 mt-6 gap-2 flex justify-end border-t border-gray-200 -mx-6 -mb-6 rounded-b-lg bg-gray-50">
                    <button id="printMemberBtn" type="button" class="py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500">In H·ªì s∆°</button>
                    <button id="closeViewModalBtn" type="button" class="py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-gray-500 text-white hover:bg-gray-600 focus:ring-gray-400">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>


    <div id="memberModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center p-4">
        <div class="relative mx-auto w-full max-w-2xl shadow-lg rounded-lg bg-white">
            <form id="memberForm" class="p-6">
                <h3 class="text-xl leading-6 font-medium text-gray-900 mb-6" id="modalTitle">Th√™m ƒê·∫£ng vi√™n</h3>
                
                <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium">H·ªç t√™n <span class="text-red-600">*</span></label>
                            <input type="text" id="hoTen" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Ng√†y sinh <span class="text-red-600">*</span></label>
                            <input type="date" id="ngaySinh" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Gi·ªõi t√≠nh <span class="text-red-600">*</span></label>
                            <select id="gioiTinh" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" required>
                                <option value="Nam">Nam</option>
                                <option value="N·ªØ">N·ªØ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Qu√™ qu√°n <span class="text-red-600">*</span></label>
                            <input type="text" id="queQuan" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">S·ªë CCCD</label>
                            <input type="text" id="cccd" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="tel" id="soDienThoai" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div class="col-span-1 md:col-span-2">
                            <label class="block text-sm font-medium">S·ªë th·∫ª ƒê·∫£ng vi√™n</label>
                            <input type="text" id="soTheDang" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Ng√†y v√†o ƒê·∫£ng (D·ª± b·ªã) <span class="text-red-600">*</span></label>
                            <input type="date" id="ngayVaoDang" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Ng√†y v√†o ƒê·∫£ng (Ch√≠nh th·ª©c) <span class="text-red-600">*</span></label>
                            <input type="date" id="ngayChinhThuc" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">H·ªçc v·∫•n</label>
                            <input type="text" id="hocVan" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" placeholder="12/12, C·ª≠ nh√¢n...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">L√Ω lu·∫≠n Ch√≠nh tr·ªã</label>
                            <input type="text" id="chinhTri" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" placeholder="Cao c·∫•p, Trung c·∫•p...">
                        </div>
                        <div class="col-span-1 md:col-span-2">
                            <label class="block text-sm font-medium">Chuy√™n m√¥n</label>
                            <input type="text" id="chuyenMon" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" placeholder="K·ªπ s∆∞ CNTT, K·∫ø to√°n...">
                        </div>

                        <div>
                            <label class="block text-sm font-medium">Ch·ª©c v·ª•</label>
                            <input type="text" id="chucVu" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" placeholder="B√≠ th∆∞, P.B√≠ th∆∞, ƒê·∫£ng vi√™n...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Tr·∫°ng th√°i</label>
                            <select id="trangThai" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2">
                                <option value="ƒêang sinh ho·∫°t">ƒêang sinh ho·∫°t</option>
                                <option value="Mi·ªÖn sinh ho·∫°t">Mi·ªÖn sinh ho·∫°t</option>
                                <option value="Chuy·ªÉn ƒëi">Chuy·ªÉn ƒëi</option>
                                <option value="ƒê√£ qua ƒë·ªùi">ƒê√£ qua ƒë·ªùi</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="pt-2">
                        <label class="block text-sm font-medium col-span-2">Huy hi·ªáu ƒê·∫£ng ƒë√£ nh·∫≠n:</label>
                        <div id="receivedMedalCheckboxes" class="grid grid-cols-4 md:grid-cols-6 gap-3 mt-2 border border-gray-200 p-3 rounded-md">
                            </div>
                    </div>
                    
                    <div class="pt-2">
                        <label class="block text-sm font-medium">Ghi ch√∫</label>
                        <textarea id="ghiChu" rows="2" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2"></textarea>
                    </div>
                </div>

                <div class="items-center px-4 py-3 mt-6 gap-2 flex justify-end border-t border-gray-200 -mx-6 -mb-6 rounded-b-lg bg-gray-50">
                    <input type="hidden" id="memberId">
                    <button id="saveBtn" type="submit" class="py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-green-600 text-white hover:bg-green-700 focus:ring-green-500">L∆∞u</button>
                    <button id="cancelBtn" type="button" class="py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-transparent text-gray-700 hover:bg-gray-100">H·ªßy</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center p-4">
        <div class="relative mx-auto w-full max-w-md shadow-lg rounded-lg bg-white">
            <div class="p-6">
                <div class="flex items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="deleteModalTitle">X√°c nh·∫≠n x√≥a</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500" id="deleteModalBody">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m·ª•c n√†y? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="items-center px-4 py-3 gap-3 flex justify-end rounded-b-lg bg-gray-50">
                <button id="confirmDeleteBtn" type="button" class="py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-red-600 text-white hover:bg-red-700 focus:ring-red-500">X√°c nh·∫≠n X√≥a</button>
                <button id="cancelDeleteBtn" type="button" class="py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-transparent text-gray-700 hover:bg-gray-100">H·ªßy</button>
            </div>
        </div>
    </div>
    
    <div id="helpModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center p-4">
        <div class="relative mx-auto w-full max-w-3xl shadow-lg rounded-lg bg-white">
            <div class="p-6">
                <h3 class="text-2xl text-center leading-6 font-bold text-gray-900 mb-6">üìñ H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h3>
                
                <div id="helpModalContent" class="mt-2 text-left space-y-6 max-h-[70vh] overflow-y-auto pr-3 text-gray-700">
                    
                    <div>
                        <h4 class="text-lg font-bold text-gray-900 mb-2">1. üîê ƒêƒÉng nh·∫≠p v√† B·∫£o m·∫≠t</h4>
                        <div class="pl-4 space-y-3">
                             <div class="bg-red-100 p-3 rounded-md border border-red-300 text-red-800 text-sm">
                                <strong class="font-semibold">QUAN TR·ªåNG: KH√îNG BAO GI·ªú QU√äN M·∫¨T KH·∫®U!</strong>
                                <br>D·ªØ li·ªáu c·ªßa b·∫°n ƒë∆∞·ª£c m√£ ho√° b·∫±ng m·∫≠t kh·∫©u n√†y. N·∫øu b·∫°n qu√™n, d·ªØ li·ªáu s·∫Ω b·ªã m·∫•t vƒ©nh vi·ªÖn v√† kh√¥ng th·ªÉ kh√¥i ph·ª•c.
                            </div>
                            <ul class="list-disc list-inside ml-4 space-y-1">
                                <li><strong>L·∫ßn ƒë·∫ßu s·ª≠ d·ª•ng:</strong> M·∫≠t kh·∫©u b·∫°n nh·∫≠p t·∫°i m√†n h√¨nh "ƒê√£ kho√°" s·∫Ω tr·ªü th√†nh m·∫≠t kh·∫©u ch·ªß ƒë·ªÉ m√£ ho√° d·ªØ li·ªáu.</li>
                                <li><strong>Nh·ªØng l·∫ßn sau:</strong> D√πng ƒë√∫ng m·∫≠t kh·∫©u ƒë√≥ ƒë·ªÉ m·ªü kho√° v√† gi·∫£i m√£ d·ªØ li·ªáu.</li>
                            </ul>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-bold text-gray-900 mb-2">2. ‚ú® Ch·ª©c nƒÉng C∆° b·∫£n (H√†ng ng√†y)</h4>
                        <div class="pl-4 space-y-3">
                            <div>
                                <h5 class="font-semibold text-gray-800">a. Th√™m ƒê·∫£ng vi√™n m·ªõi</h5>
                                <ol class="list-decimal list-inside ml-4 space-y-1">
                                    <li>Nh·∫•n n√∫t m√†u xanh <strong class="text-blue-600">"+ Th√™m ƒê·∫£ng vi√™n"</strong>.</li>
                                    <li>ƒêi·ªÅn c√°c th√¥ng tin (SƒêT, H·ªçc v·∫•n, Ch√≠nh tr·ªã, Chuy√™n m√¥n...).</li>
                                    <li>T·∫°i m·ª•c "Huy hi·ªáu ƒê·∫£ng ƒë√£ nh·∫≠n", h√£y t√≠ch ch·ªçn v√†o c√°c m·ªëc m√† ƒê·∫£ng vi√™n ƒë√≥ <em>ƒë√£</em> ƒë∆∞·ª£c trao.</li>
                                    <li>Nh·∫•n <strong>"L∆∞u"</strong>. H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông ki·ªÉm tra l·ªói (v√≠ d·ª•: Ng√†y ch√≠nh th·ª©c tr∆∞·ªõc ng√†y d·ª± b·ªã) tr∆∞·ªõc khi l∆∞u.</li>
                                </ol>
                            </div>
                            <div>
                                <h5 class="font-semibold text-gray-800">b. Xem Th√¥ng tin Chi ti·∫øt</h5>
                                <ol class="list-decimal list-inside ml-4 space-y-1">
                                    <li>T·∫°i h√†ng c·ªßa ƒê·∫£ng vi√™n, nh·∫•n n√∫t <strong>"Xem"</strong> (m√†u xanh l√°).</li>
                                    <li>Modal chi ti·∫øt s·∫Ω hi·ªán ra, hi·ªÉn th·ªã <em>to√†n b·ªô</em> th√¥ng tin, bao g·ªìm c·∫£ "Tu·ªïi ƒë·ªùi" v√† "Tu·ªïi ƒê·∫£ng" (t√≠nh t·ª´ ng√†y d·ª± b·ªã).</li>
                                    <li>T·∫°i m·ª•c "T√≠nh tu·ªïi ƒê·∫£ng (c√°c m·ªëc)", b·∫°n c√≥ th·ªÉ ch·ªçn m·ªôt nƒÉm b·∫•t k·ª≥ ƒë·ªÉ xem tu·ªïi ƒê·∫£ng t·∫°i 4 m·ªëc l·ªÖ (03/02, 19/5, 02/09, 07/11).</li>
                                    <li>(M·ªöI) Nh·∫•n n√∫t <strong>"In H·ªì s∆°"</strong> ƒë·ªÉ t·∫°o m·ªôt trang A4 S∆° y·∫øu l√Ω l·ªãch chu·∫©n ƒë·ªÉ in ·∫•n.</li>
                                </ol>
                            </div>
                            <div>
                                <h5 class="font-semibold text-gray-800">c. S·ª≠a th√¥ng tin ƒê·∫£ng vi√™n</h5>
                                <ol class="list-decimal list-inside ml-4 space-y-1">
                                    <li>Nh·∫•n n√∫t <strong>"S·ª≠a"</strong> (m√†u xanh d∆∞∆°ng) t·∫°i h√†ng c·ªßa ƒê·∫£ng vi√™n.</li>
                                    <li>Khi m·ªôt ƒê·∫£ng vi√™n v·ª´a nh·∫≠n Huy hi·ªáu m·ªõi, b·∫°n ph·∫£i v√†o ƒë√¢y v√† <strong>t√≠ch ch·ªçn th√™m v√†o √¥ huy hi·ªáu ƒë√≥</strong>.</li>
                                    <li>Nh·∫•n <strong>"L∆∞u"</strong> ƒë·ªÉ c·∫≠p nh·∫≠t.</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-bold text-gray-900 mb-2">3. üîç T√¨m ki·∫øm, S·∫Øp x·∫øp & L·ªçc</h4>
                        <div class="pl-4 space-y-3">
                            <p><strong>√î T√¨m ki·∫øm:</strong> G√µ b·∫•t c·ª© g√¨ (H·ªç t√™n, Qu√™ qu√°n, SƒêT, CCCD,...) ƒë·ªÉ t√¨m ki·∫øm. Danh s√°ch s·∫Ω t·ª± ƒë·ªông l·ªçc l·∫°i.</p>
                            <div>
                                <h5 class="font-semibold text-gray-800">N√∫t "S·∫Øp x·∫øp & L·ªçc" (h√¨nh c√°i ph·ªÖu)</h5>
                                <p>Nh·∫•n v√†o n√∫t n√†y ƒë·ªÉ m·ªü menu t√πy ch·ªçn:</p>
                                <ul class="list-disc list-inside ml-4 space-y-1">
                                    <li><strong>S·∫Øp x·∫øp theo:</strong> X·∫øp danh s√°ch theo Tu·ªïi ƒê·∫£ng (Cao-Th·∫•p ho·∫∑c Th·∫•p-Cao) v√† H·ªç t√™n (A-Z ho·∫∑c Z-A).</li>
                                    <li><strong>L·ªçc theo Gi·ªõi t√≠nh:</strong> Ch·ªâ xem Nam, N·ªØ, ho·∫∑c T·∫•t c·∫£.</li>
                                    <li><strong>L·ªçc theo Huy hi·ªáu:</strong> L·ªçc nhanh danh s√°ch "S·∫Øp nh·∫≠n Huy hi·ªáu".</li>
                                </ul>
                            </div>
                            <p><strong>Hi·ªÉn th·ªã .../trang:</strong> N·∫±m ·ªü g√≥c d∆∞·ªõi b√™n tr√°i c·ªßa b·∫£ng, cho ph√©p b·∫°n ch·ªçn xem 10, 20, 50, ho·∫∑c 100 m·ª•c tr√™n m·ªôt trang.</p>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-bold text-gray-900 mb-2">4. ‚ö†Ô∏è Sao l∆∞u v√† Ph·ª•c h·ªìi (M√É HO√Å)</h4>
                        <div class="pl-4 space-y-3">
                            <div class="bg-yellow-100 p-3 rounded-md border border-yellow-300 text-yellow-800 text-sm">
                                <strong class="font-semibold">C·∫£nh b√°o:</strong> D·ªØ li·ªáu ƒë∆∞·ª£c m√£ ho√° b·∫±ng m·∫≠t kh·∫©u c·ªßa b·∫°n. N·∫øu qu√™n m·∫≠t kh·∫©u, file sao l∆∞u c≈©ng s·∫Ω V√î D·ª§NG.
                            </div>
                            
                            <div>
                                <h5 class="font-semibold text-gray-800">a. C√°ch Sao l∆∞u (N√™n l√†m h√†ng tu·∫ßn)</h5>
                                <ol class="list-decimal list-inside ml-4 space-y-1">
                                    <li>Nh·∫•n n√∫t <strong>"Xu·∫•t JSON"</strong> (m√†u xanh l√°).</li>
                                    <li>M·ªôt t·ªáp <code>...encrypted.json.txt</code> s·∫Ω ƒë∆∞·ª£c t·∫£i v·ªÅ. ƒê√¢y l√† file ƒë√£ ƒë∆∞·ª£c m√£ ho√°.</li>
                                    <li>H√£y c·∫•t t·ªáp n√†y v√†o n∆°i an to√†n (USB, Google Drive...).</li>
                                </ol>
                            </div>
                            <div>
                                <h5 class="font-semibold text-gray-800">b. C√°ch Ph·ª•c h·ªìi (Khi m·∫•t d·ªØ li·ªáu)</h5>
                                <ol class="list-decimal list-inside ml-4 space-y-1">
                                    <li>M·ªü t·ªáp <code>quanlydangvien.html</code>.</li>
                                    <li>ƒêƒÉng nh·∫≠p b·∫±ng m·∫≠t kh·∫©u c·ªßa b·∫°n.</li>
                                    <li>Nh·∫•n v√†o n√∫t <strong>"Nh·∫≠p JSON (Restore)"</strong> (m√†u v√†ng).</li>
                                    <li>Ch·ªçn t·ªáp <code>...encrypted.json.txt</code> m√† b·∫°n ƒë√£ sao l∆∞u.</li>
                                    <li>H·ªá th·ªëng s·∫Ω d√πng m·∫≠t kh·∫©u b·∫°n ƒëang ƒëƒÉng nh·∫≠p ƒë·ªÉ gi·∫£i m√£ v√† kh√¥i ph·ª•c. (N√≥ c≈©ng c√≥ th·ªÉ ƒë·ªçc ƒë∆∞·ª£c file JSON c≈© kh√¥ng m√£ ho√°).</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="items-center px-4 py-3 mt-6 gap-2 flex justify-end border-t border-gray-200 -mx-6 -mb-6 rounded-b-lg bg-gray-50">
                    <button id="closeHelpModalBtn" type="button" class="py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-gray-500 text-white hover:bg-gray-600 focus:ring-gray-400">ƒê√£ hi·ªÉu</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Danh s√°ch c√°c m·ªëc Huy hi·ªáu ƒê·∫£ng
            const ALL_MILESTONES = [30, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90];
            
            // Khai b√°o c√°c bi·∫øn DOM
            const memberTableBody = document.getElementById('memberTableBody');
            const addMemberBtn = document.getElementById('addMemberBtn');
            const memberModal = document.getElementById('memberModal'); // Modal S·ª≠a
            const memberForm = document.getElementById('memberForm');
            const cancelBtn = document.getElementById('cancelBtn');
            const modalTitle = document.getElementById('modalTitle');
            const searchInput = document.getElementById('searchInput');
            
            // DOM cho Menu L·ªçc
            const filterMenuBtn = document.getElementById('filterMenuBtn');
            const filterMenu = document.getElementById('filterMenu');
            
            const receivedMedalCheckboxes = document.getElementById('receivedMedalCheckboxes');
            
            // DOM cho Modal Xem
            const viewModal = document.getElementById('viewModal');
            const viewModalTitle = document.getElementById('viewModalTitle');
            const viewModalContent = document.getElementById('viewModalContent');
            const closeViewModalBtn = document.getElementById('closeViewModalBtn');
            const printMemberBtn = document.getElementById('printMemberBtn'); 

            // DOM cho Modal X√≥a
            const deleteModal = document.getElementById('deleteModal');
            const deleteModalTitle = document.getElementById('deleteModalTitle');
            const deleteModalBody = document.getElementById('deleteModalBody');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            
            // DOM cho Modal H∆∞·ªõng d·∫´n
            const helpBtn = document.getElementById('helpBtn');
            const helpModal = document.getElementById('helpModal');
            const closeHelpModalBtn = document.getElementById('closeHelpModalBtn');
            
            // DOM cho Modal ƒêƒÉng nh·∫≠p
            const authModal = document.getElementById('authModal');
            const appContainer = document.getElementById('appContainer');
            const passwordInput = document.getElementById('passwordInput');
            const loginBtn = document.getElementById('loginBtn');


            // JSON buttons
            const exportBtn = document.getElementById('exportBtn');
            const importInput = document.getElementById('importInput');

            // CSV buttons
            const downloadCsvTemplateBtn = document.getElementById('downloadCsvTemplateBtn');
            const importCsvInput = document.getElementById('importCsvInput');
            const exportCsvBtn = document.getElementById('exportCsvBtn');

            // Bulk Delete buttons
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');

            // Pagination DOM
            const paginationControls = document.getElementById('paginationControls');
            const itemsPerPageSelect = document.getElementById('itemsPerPageSelect');

            // Dashboard stats
            const statTotal = document.getElementById('statTotal');
            const statMale = document.getElementById('statMale');
            const statFemale = document.getElementById('statFemale');
            const statMedal = document.getElementById('statMedal');

            // Bi·∫øn state ch√≠nh
            let members = [];
            let appKey = null; // Ch√¨a kho√° m√£ ho√°

            // Bi·∫øn state cho ph√¢n trang
            let currentPage = 1;
            let totalPages = 1;
            let itemsPerPage = 10; 
            
            // Bi·∫øn state cho L·ªçc & S·∫Øp x·∫øp
            let currentSort = 'partyAge_desc'; 
            let currentGenderFilter = 'all'; 
            let currentMedalFilter = 'all'; 
            
            // Bi·∫øn state cho vi·ªác x√≥a
            let itemToDelete = null; 
            
            // Bi·∫øn state cho vi·ªác in
            let memberToPrint = null;

            // --- C√ÅC H√ÄM X·ª¨ L√ù D·ªÆ LI·ªÜU (M√É HO√Å) ---

            /**
             * (C·∫¨P NH·∫¨T) T·∫£i v√† GI·∫¢I M√É d·ªØ li·ªáu (X·ª≠ l√Ω c·∫£ tr∆∞·ªùng h·ª£p n√¢ng c·∫•p)
             */
            function loadFromLocalStorage() {
                if (!appKey) {
                    console.error("Ch∆∞a c√≥ ch√¨a kho√° (appKey)!");
                    return false;
                }

                const encryptedData = localStorage.getItem('partyMembers_encrypted');
                const oldData = localStorage.getItem('partyMembers'); // Key c≈© kh√¥ng m√£ ho√°

                if (!encryptedData && oldData) {
                    // --- TR∆Ø·ªúNG H·ª¢P N√ÇNG C·∫§P ---
                    // L·∫ßn ƒë·∫ßu ch·∫°y, c√≥ d·ªØ li·ªáu c≈©, ch∆∞a c√≥ d·ªØ li·ªáu m·ªõi
                    try {
                        console.log("ƒêang di chuy·ªÉn d·ªØ li·ªáu c≈© (kh√¥ng m√£ ho√°)...");
                        members = JSON.parse(oldData);
                        if (!Array.isArray(members)) members = [];
                        
                        saveToLocalStorage(); // L∆∞u l·∫°i d∆∞·ªõi d·∫°ng m√£ ho√°
                        localStorage.removeItem('partyMembers'); // X√≥a key c≈©
                        console.log("Di chuy·ªÉn d·ªØ li·ªáu th√†nh c√¥ng!");
                        return true;
                    } catch (e) {
                        console.error("L·ªói khi di chuy·ªÉn d·ªØ li·ªáu c≈©:", e);
                        members = [];
                        return true; // Coi nh∆∞ d·ªØ li·ªáu m·ªõi
                    }
                }

                if (!encryptedData) {
                    // L·∫ßn ƒë·∫ßu s·ª≠ d·ª•ng, kh√¥ng c√≥ d·ªØ li·ªáu c≈©
                    members = [];
                    return true;
                }
                
                // --- TR∆Ø·ªúNG H·ª¢P S·ª¨ D·ª§NG B√åNH TH∆Ø·ªúNG ---
                try {
                    const decryptedBytes = CryptoJS.AES.decrypt(encryptedData, appKey);
                    const decryptedData = decryptedBytes.toString(CryptoJS.enc.Utf8);
                    
                    if (!decryptedData) {
                        throw new Error("Gi·∫£i m√£ ra chu·ªói r·ªóng (Sai m·∫≠t kh·∫©u?)");
                    }
                    
                    members = JSON.parse(decryptedData);
                    if (!Array.isArray(members)) {
                         members = [];
                         throw new Error("D·ªØ li·ªáu b·ªã l·ªói");
                    }
                    return true; // Gi·∫£i m√£ th√†nh c√¥ng
                } catch (e) {
                    console.error("L·ªói gi·∫£i m√£:", e);
                    members = [];
                    return false; // Gi·∫£i m√£ th·∫•t b·∫°i (sai m·∫≠t kh·∫©u)
                }
            }

            /**
             * (C·∫¨P NH·∫¨T) M√É HO√Å v√† L∆∞u d·ªØ li·ªáu
             */
            function saveToLocalStorage() {
                if (!appKey) {
                    console.error("Kh√¥ng th·ªÉ l∆∞u v√¨ ch∆∞a c√≥ ch√¨a kho√° (appKey)!");
                    return;
                }
                try {
                    const dataString = JSON.stringify(members);
                    const encryptedData = CryptoJS.AES.encrypt(dataString, appKey).toString();
                    localStorage.setItem('partyMembers_encrypted', encryptedData);
                } catch (e) {
                    console.error("L·ªói m√£ ho√°:", e);
                    alert("ƒê√£ x·∫£y ra l·ªói nghi√™m tr·ªçng khi m√£ ho√° d·ªØ li·ªáu! Vui l√≤ng sao l∆∞u JSON ngay l·∫≠p t·ª©c.");
                }
            }
            
            function calculateAgeAtDate(startDateString, endDate) {
                if (!startDateString) return 0;
                const birthDate = new Date(startDateString);
                let age = endDate.getFullYear() - birthDate.getFullYear();
                const m = endDate.getMonth() - birthDate.getMonth();
                if (m < 0 || (m === 0 && endDate.getDate() < birthDate.getDate())) {
                    age--;
                }
                return age;
            }

            function getTuoiDoi(ngaySinh) {
                return calculateAgeAtDate(ngaySinh, new Date());
            }

            function getTuoiDang(ngayVaoDang) {
                return calculateAgeAtDate(ngayVaoDang, new Date());
            }

            function getUpcomingMedal(ngayVaoDang, receivedMedals = []) {
                if (!ngayVaoDang) return 'N/A';
                
                const partyAge = getTuoiDang(ngayVaoDang); 
                const received = receivedMedals || [];
                let nextMilestone = null;

                for (const m of ALL_MILESTONES) {
                    if (!received.includes(m)) {
                        nextMilestone = m; 
                        break;
                    }
                }

                if (nextMilestone === null) {
                    return `ƒê√£ nh·∫≠n ${ALL_MILESTONES[ALL_MILESTONES.length - 1]} nƒÉm`;
                }

                const officialDate = new Date(ngayVaoDang);
                const milestoneDate = new Date(officialDate.getFullYear() + nextMilestone, officialDate.getMonth(), officialDate.getDate());
                
                const today = new Date();
                const oneYearFromNow = new Date();
                oneYearFromNow.setFullYear(today.getFullYear() + 1);

                if (milestoneDate > today && milestoneDate <= oneYearFromNow) {
                    return `S·∫Øp nh·∫≠n ${nextMilestone} nƒÉm`;
                }
                
                return ''; 
            }
            
            function getTrangThaiClass(trangThai) {
                switch (trangThai) {
                    case 'ƒêang sinh ho·∫°t':
                        return 'bg-green-100 text-green-800';
                    case 'Mi·ªÖn sinh ho·∫°t':
                        return 'bg-yellow-100 text-yellow-800';
                    case 'Chuy·ªÉn ƒëi':
                        return 'bg-blue-100 text-blue-800';
                    case 'ƒê√£ qua ƒë·ªùi':
                        return 'bg-gray-100 text-gray-800';
                    default:
                        return 'bg-gray-100 text-gray-800';
                }
            }

            function renderTable(dataToRender) {
                memberTableBody.innerHTML = '';
                if (dataToRender.length === 0) {
                    memberTableBody.innerHTML = '<tr><td colspan="7" class="text-center p-6 text-gray-500">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu</td></tr>';
                    return;
                }

                dataToRender.forEach(member => {
                    const partyAge = getTuoiDang(member.ngayVaoDang); 
                    const upcomingMedal = getUpcomingMedal(member.ngayVaoDang, member.receivedMedals) || ''; 

                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="py-3 px-4 border-b border-gray-200 text-center">
                                <input type="checkbox" class="member-checkbox rounded border-gray-300 text-blue-500 focus:ring-blue-500" data-id="${member.id}">
                            </td>
                            <td class="py-3 px-4 border-b border-gray-200 text-center text-sm text-gray-600">${member.id}</td>
                            <td class="py-3 px-4 border-b border-gray-200 font-medium text-gray-900">${member.hoTen}</td>
                            <td class="py-3 px-4 border-b border-gray-200 text-center font-bold text-gray-800">${partyAge}</td>
                            <td class="py-3 px-4 border-b border-gray-200 text-center text-red-600 font-medium">${upcomingMedal}</td>
                            <td class="py-3 px-4 border-b border-gray-200 text-center text-sm">
                                <span class="px-2 py-1 font-semibold leading-tight text-xs rounded-full ${getTrangThaiClass(member.trangThai)}">
                                    ${member.trangThai || '...'}
                                </span>
                            </td>
                            <td class="py-3 px-4 border-b border-gray-200 text-center whitespace-nowrap">
                                <button class="view-btn text-green-600 hover:text-green-800 font-medium py-1 px-2 rounded hover:bg-green-100" data-id="${member.id}">Xem</button>
                                <button class="edit-btn text-blue-600 hover:text-blue-800 font-medium py-1 px-2 rounded ml-1 hover:bg-blue-100" data-id="${member.id}">S·ª≠a</button>
                                <button class="delete-btn text-red-600 hover:text-red-800 font-medium py-1 px-2 rounded ml-1 hover:bg-red-100" data-id="${member.id}">X√≥a</button>
                            </td>
                        </tr>
                    `;
                    memberTableBody.innerHTML += row;
                });
            }

            function updateDashboard(data) {
                statTotal.textContent = data.length;
                statMale.textContent = data.filter(m => m.gioiTinh === 'Nam').length;
                statFemale.textContent = data.filter(m => m.gioiTinh === 'N·ªØ').length;
                statMedal.textContent = data.filter(m => getUpcomingMedal(m.ngayVaoDang, m.receivedMedals).startsWith('S·∫Øp nh·∫≠n')).length;
            }

            function applyFiltersAndRender() {
                itemsPerPage = parseInt(itemsPerPageSelect.value);

                // --- 1. L·ªåC D·ªÆ LI·ªÜU ---
                const searchTerm = searchInput.value.toLowerCase();
                const gender = currentGenderFilter;
                const medalFilter = currentMedalFilter;
                
                let filteredMembers = members;
                
                if (searchTerm) {
                    filteredMembers = filteredMembers.filter(m => 
                        m.hoTen.toLowerCase().includes(searchTerm) ||
                        (m.queQuan && m.queQuan.toLowerCase().includes(searchTerm)) ||
                        (m.cccd && m.cccd.includes(searchTerm)) ||
                        (m.soDienThoai && m.soDienThoai.includes(searchTerm)) || 
                        (m.soTheDang && m.soTheDang.includes(searchTerm))
                    );
                }
                
                if (gender !== 'all') { 
                    filteredMembers = filteredMembers.filter(m => m.gioiTinh === gender);
                }

                if (medalFilter === 'upcoming') {
                    filteredMembers = filteredMembers.filter(m => 
                        getUpcomingMedal(m.ngayVaoDang, m.receivedMedals).startsWith('S·∫Øp nh·∫≠n')
                    );
                }
                
                // --- 2. S·∫ÆP X·∫æP ---
                switch (currentSort) {
                    case 'partyAge_desc':
                        filteredMembers.sort((a, b) => getTuoiDang(b.ngayVaoDang) - getTuoiDang(a.ngayVaoDang));
                        break;
                    case 'partyAge_asc':
                        filteredMembers.sort((a, b) => getTuoiDang(a.ngayVaoDang) - getTuoiDang(b.ngayVaoDang));
                        break;
                    case 'name_asc':
                        filteredMembers.sort((a, b) => a.hoTen.localeCompare(b.hoTen, 'vi'));
                        break;
                    case 'name_desc':
                        filteredMembers.sort((a, b) => b.hoTen.localeCompare(a.hoTen, 'vi'));
                        break;
                }

                // --- 3. C·∫¨P NH·∫¨T DASHBOARD ---
                updateDashboard(filteredMembers);

                // --- 4. T√çNH TO√ÅN PH√ÇN TRANG ---
                const totalItems = filteredMembers.length;
                totalPages = Math.ceil(totalItems / itemsPerPage);
                if (totalPages === 0) totalPages = 1;
                if (currentPage > totalPages) {
                    currentPage = 1;
                }
                
                // --- 5. C·∫ÆT D·ªÆ LI·ªÜU ---
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const paginatedItems = filteredMembers.slice(startIndex, endIndex);
                
                // --- 6. RENDER ---
                renderTable(paginatedItems); 
                renderPagination(); 
                
                selectAllCheckbox.checked = false;
                updateBulkDeleteButtonState();
            }

            function renderPagination() {
                paginationControls.innerHTML = ''; 
                
                const baseButtonClass = "py-1.5 px-3 rounded-md border text-sm";
                const activeText = "bg-blue-600 text-white border-blue-600";
                const defaultText = "bg-white text-gray-700 hover:bg-gray-50 border-gray-300";
                const disabledText = "text-gray-300 cursor-not-allowed bg-gray-50 border-gray-200";

                const prevButton = document.createElement('button');
                prevButton.textContent = 'Tr∆∞·ªõc';
                prevButton.dataset.page = 'prev';
                prevButton.className = `${baseButtonClass} ${defaultText}`;
                if (currentPage === 1) {
                    prevButton.disabled = true;
                    prevButton.className = `${baseButtonClass} ${disabledText}`;
                }
                paginationControls.appendChild(prevButton);

                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, currentPage + 2);
                if (currentPage <= 3) {
                    endPage = Math.min(5, totalPages);
                }
                if (currentPage > totalPages - 3) {
                    startPage = Math.max(1, totalPages - 4);
                }
                if (startPage > 1) {
                    paginationControls.appendChild(createPageButton(1));
                    if(startPage > 2) paginationControls.appendChild(createPageEllipsis());
                }
                for (let i = startPage; i <= endPage; i++) {
                    paginationControls.appendChild(createPageButton(i));
                }
                if (endPage < totalPages) {
                    if(endPage < totalPages - 1) paginationControls.appendChild(createPageEllipsis());
                    paginationControls.appendChild(createPageButton(totalPages));
                }
                
                const nextButton = document.createElement('button');
                nextButton.textContent = 'Sau';
                nextButton.dataset.page = 'next';
                nextButton.className = `${baseButtonClass} ${defaultText}`;
                if (currentPage === totalPages) {
                    nextButton.disabled = true;
                    nextButton.className = `${baseButtonClass} ${disabledText}`;
                }
                paginationControls.appendChild(nextButton);
            }

            function createPageButton(pageNumber) {
                const baseButtonClass = "py-1.5 px-3 rounded-md border text-sm";
                const activeText = "bg-blue-600 text-white border-blue-600";
                const defaultText = "bg-white text-gray-700 hover:bg-gray-50 border-gray-300";

                const button = document.createElement('button');
                button.textContent = pageNumber;
                button.dataset.page = pageNumber;
                button.className = `${baseButtonClass} ${pageNumber === currentPage ? activeText : defaultText}`;
                return button;
            }

            function createPageEllipsis() {
                const span = document.createElement('span');
                span.textContent = '...';
                span.className = 'py-1 px-2 text-gray-500';
                return span;
            }


            function updateMilestoneAges(year, ngayVaoDang) {
                if (!ngayVaoDang) return; 
                const y = parseInt(year);
                
                const dateFeb3 = new Date(y, 1, 3); 
                const dateMay19 = new Date(y, 4, 19); 
                const dateSep2 = new Date(y, 8, 2); 
                const dateNov7 = new Date(y, 10, 7);

                const ageAtFeb3 = calculateAgeAtDate(ngayVaoDang, dateFeb3);
                const ageAtMay19 = calculateAgeAtDate(ngayVaoDang, dateMay19); 
                const ageAtSep2 = calculateAgeAtDate(ngayVaoDang, dateSep2);
                const ageAtNov7 = calculateAgeAtDate(ngayVaoDang, dateNov7);
                
                document.getElementById('labelFeb3').textContent = `T·∫°i m·ªëc 03/02/${y}:`;
                document.getElementById('ageAtFeb3').textContent = `${ageAtFeb3} nƒÉm`;
                document.getElementById('labelMay19').textContent = `T·∫°i m·ªëc 19/05/${y}:`; 
                document.getElementById('ageAtMay19').textContent = `${ageAtMay19} nƒÉm`; 
                document.getElementById('labelSep2').textContent = `T·∫°i m·ªëc 02/09/${y}:`;
                document.getElementById('ageAtSep2').textContent = `${ageAtSep2} nƒÉm`;
                document.getElementById('labelNov7').textContent = `T·∫°i m·ªëc 07/11/${y}:`;
                document.getElementById('ageAtNov7').textContent = `${ageAtNov7} nƒÉm`;
            }

            function openViewModal(memberId) {
                const member = members.find(m => m.id === memberId);
                if (!member) return;
                
                memberToPrint = memberId; 

                viewModalTitle.textContent = `ƒê·∫£ng vi√™n: ${member.hoTen}`;
                
                const tuoiDoi = getTuoiDoi(member.ngaySinh);
                const partyAge = getTuoiDang(member.ngayVaoDang);
                const upcomingMedal = getUpcomingMedal(member.ngayVaoDang, member.receivedMedals) || 'Kh√¥ng c√≥';
                const received = member.receivedMedals || [];
                const receivedText = received.length > 0 ? received.join(', ') + ' nƒÉm' : 'Ch∆∞a nh·∫≠n';

                viewModalContent.innerHTML = `
                    <div>
                        <h4 class="text-sm font-bold uppercase text-gray-400 mb-3">Th√¥ng tin c√° nh√¢n</h4>
                        <dl class="grid grid-cols-2 gap-x-4 gap-y-4">
                            <div>
                                <dt class="text-sm font-medium text-gray-500">H·ªç t√™n:</dt>
                                <dd class="text-base font-semibold text-gray-900">${member.hoTen}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Ng√†y sinh (Tu·ªïi ƒë·ªùi):</dt>
                                <dd class="text-base font-semibold text-gray-900">${formatDate(member.ngaySinh)} (${tuoiDoi} tu·ªïi)</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Gi·ªõi t√≠nh:</dt>
                                <dd class="text-base font-semibold text-gray-900">${member.gioiTinh}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Qu√™ qu√°n:</dt>
                                <dd class="text-base font-semibold text-gray-900">${member.queQuan || 'Ch∆∞a c·∫≠p nh·∫≠t'}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">S·ªë CCCD:</dt>
                                <dd class="text-base font-semibold text-gray-900">${member.cccd || 'Ch∆∞a c·∫≠p nh·∫≠t'}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">S·ªë ƒëi·ªán tho·∫°i:</dt>
                                <dd class="text-base font-semibold text-gray-900">${member.soDienThoai || 'Ch∆∞a c·∫≠p nh·∫≠t'}</dd>
                            </div>
                            <div class="col-span-2">
                                <dt class="text-sm font-medium text-gray-500">S·ªë th·∫ª ƒê·∫£ng:</dt>
                                <dd class="text-base font-semibold text-gray-900">${member.soTheDang || 'Ch∆∞a c·∫≠p nh·∫≠t'}</dd>
                            </div>
                        </dl>
                    </div>

                    <div>
                        <h4 class="text-sm font-bold uppercase text-gray-400 mb-3">Tr√¨nh ƒë·ªô</h4>
                        <dl class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-4">
                            <div>
                                <dt class="text-sm font-medium text-gray-500">H·ªçc v·∫•n:</dt>
                                <dd class="text-base font-semibold text-gray-900">${member.hocVan || 'Ch∆∞a c·∫≠p nh·∫≠t'}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">L√Ω lu·∫≠n Ch√≠nh tr·ªã:</dt>
                                <dd class="text-base font-semibold text-gray-900">${member.chinhTri || 'Ch∆∞a c·∫≠p nh·∫≠t'}</dd>
                            </div>
                            <div class="col-span-1 md:col-span-2">
                                <dt class="text-sm font-medium text-gray-500">Chuy√™n m√¥n:</dt>
                                <dd class="text-base font-semibold text-gray-900">${member.chuyenMon || 'Ch∆∞a c·∫≠p nh·∫≠t'}</dd>
                            </div>
                        </dl>
                    </div>

                    <div>
                        <h4 class="text-sm font-bold uppercase text-gray-400 mb-3">Th√¥ng tin ƒê·∫£ng</h4>
                        <dl class="grid grid-cols-2 gap-x-4 gap-y-4">
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Ng√†y v√†o ƒê·∫£ng (D·ª± b·ªã):</dt>
                                <dd class="text-base font-semibold text-gray-900">${formatDate(member.ngayVaoDang)}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Ng√†y v√†o ƒê·∫£ng (Ch√≠nh th·ª©c):</dt>
                                <dd class="text-base font-semibold text-gray-900">${formatDate(member.ngayChinhThuc)}</dd>
                            </div>
                             <div>
                                <dt class="text-sm font-medium text-gray-500">Tu·ªïi ƒê·∫£ng:</dt>
                                <dd class="text-base font-semibold text-gray-900">${partyAge} nƒÉm</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Huy hi·ªáu ƒë√£ nh·∫≠n:</dt>
                                <dd class="text-base font-semibold text-gray-900">${receivedText}</dd>
                            </div>
                            <div class="col-span-2">
                                <dt class="text-sm font-medium text-gray-500">Huy hi·ªáu s·∫Øp t·ªõi (ch∆∞a nh·∫≠n):</dt>
                                <dd class="text-base font-semibold text-red-600">${upcomingMedal}</dd>
                            </div>
                        </dl>
                    </div>

                    <div>
                        <h4 class="text-sm font-bold uppercase text-gray-400 mb-3">T√≠nh tu·ªïi ƒê·∫£ng (c√°c m·ªëc)</h4>
                        
                        <div class="mb-3">
                            <label for="milestoneYearSelect" class="text-sm font-medium text-gray-700">Ch·ªçn nƒÉm t√≠nh m·ªëc:</label>
                            <select id="milestoneYearSelect" class="w-full mt-1 p-2 border border-gray-300 rounded-md bg-gray-50"></select>
                        </div>
                        
                        <dl class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-3">
                            <div>
                                <dt class="text-sm font-medium text-gray-500" id="labelFeb3">T·∫°i m·ªëc 03/02/YYYY:</dt>
                                <dd class="text-base font-semibold text-gray-900" id="ageAtFeb3">-- nƒÉm</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500" id="labelMay19">T·∫°i m·ªëc 19/05/YYYY:</dt>
                                <dd class="text-base font-semibold text-gray-900" id="ageAtMay19">-- nƒÉm</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500" id="labelSep2">T·∫°i m·ªëc 02/09/YYYY:</dt>
                                <dd class="text-base font-semibold text-gray-900" id="ageAtSep2">-- nƒÉm</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500" id="labelNov7">T·∫°i m·ªëc 07/11/YYYY:</dt>
                                <dd class="text-base font-semibold text-gray-900" id="ageAtNov7">-- nƒÉm</dd>
                            </div>
                        </dl>
                    </div>

                    <div>
                        <h4 class="text-sm font-bold uppercase text-gray-400 mb-3">Th√¥ng tin kh√°c</h4>
                        <dl class="grid grid-cols-2 gap-x-4 gap-y-4">
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Ch·ª©c v·ª•:</dt>
                                <dd class="text-base font-semibold text-gray-900">${member.chucVu || 'ƒê·∫£ng vi√™n'}</dd>
                            </div>
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Tr·∫°ng th√°i:</dt>
                                <dd class="text-base font-semibold text-gray-900">${member.trangThai}</dd>
                            </div>
                            <div class="col-span-2">
                                <dt class="text-sm font-medium text-gray-500">Ghi ch√∫:</dt>
                                <dd class="text-base font-semibold text-gray-900">${member.ghiChu || 'Kh√¥ng c√≥'}</dd>
                            </div>
                        </dl>
                    </div>
                `;
                
                const yearSelect = document.getElementById('milestoneYearSelect');
                if (yearSelect) {
                    const today = new Date();
                    const currentYear = today.getFullYear();
                    
                    for (let i = currentYear - 5; i <= currentYear + 4; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = i;
                        yearSelect.appendChild(option);
                    }
                    
                    yearSelect.value = currentYear; 

                    yearSelect.addEventListener('change', (e) => {
                        updateMilestoneAges(e.target.value, member.ngayVaoDang); 
                    });
                    
                    updateMilestoneAges(currentYear, member.ngayVaoDang);
                }
                
                viewModal.classList.add('show');
            }

            function closeViewModal() {
                memberToPrint = null;
                viewModal.classList.remove('show');
            }

            // --- C√ÅC H√ÄM X·ª¨ L√ù MODAL "S·ª¨A" ---

            function openModal(memberId = null) {
                memberForm.reset();
                
                document.querySelectorAll('#memberForm .received-medal').forEach(cb => cb.checked = false);
                
                if (memberId) {
                    // Ch·∫ø ƒë·ªô S·ª≠a
                    const member = members.find(m => m.id === memberId);
                    modalTitle.textContent = 'Ch·ªânh s·ª≠a th√¥ng tin ƒê·∫£ng vi√™n';
                    document.getElementById('memberId').value = member.id;
                    document.getElementById('hoTen').value = member.hoTen;
                    document.getElementById('ngaySinh').value = member.ngaySinh;
                    document.getElementById('gioiTinh').value = member.gioiTinh;
                    document.getElementById('queQuan').value = member.queQuan;
                    document.getElementById('cccd').value = member.cccd;
                    document.getElementById('soDienThoai').value = member.soDienThoai || ''; 
                    document.getElementById('soTheDang').value = member.soTheDang;
                    document.getElementById('ngayVaoDang').value = member.ngayVaoDang;
                    document.getElementById('ngayChinhThuc').value = member.ngayChinhThuc;
                    document.getElementById('hocVan').value = member.hocVan || '';
                    document.getElementById('chinhTri').value = member.chinhTri || '';
                    document.getElementById('chuyenMon').value = member.chuyenMon || '';
                    document.getElementById('chucVu').value = member.chucVu;
                    document.getElementById('trangThai').value = member.trangThai;
                    document.getElementById('ghiChu').value = member.ghiChu;
                    
                    if (member.receivedMedals && Array.isArray(member.receivedMedals)) {
                        member.receivedMedals.forEach(medalYear => {
                            const checkbox = document.querySelector(`#memberForm .received-medal[value="${medalYear}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                } else {
                    // Ch·∫ø ƒë·ªô Th√™m m·ªõi
                    modalTitle.textContent = 'Th√™m ƒê·∫£ng vi√™n';
                    document.getElementById('memberId').value = '';
                }
                memberModal.classList.add('show');
            }

            function closeModal() {
                memberModal.classList.remove('show');
                memberForm.reset();
            }

            function handleFormSubmit(event) {
                event.preventDefault();
                
                const receivedCheckboxes = document.querySelectorAll('#memberForm .received-medal:checked');
                const receivedMedals = Array.from(receivedCheckboxes).map(cb => parseInt(cb.value));

                const memberData = {
                    hoTen: document.getElementById('hoTen').value,
                    ngaySinh: document.getElementById('ngaySinh').value,
                    gioiTinh: document.getElementById('gioiTinh').value,
                    queQuan: document.getElementById('queQuan').value,
                    cccd: document.getElementById('cccd').value,
                    soDienThoai: document.getElementById('soDienThoai').value, 
                    soTheDang: document.getElementById('soTheDang').value,
                    ngayVaoDang: document.getElementById('ngayVaoDang').value,
                    ngayChinhThuc: document.getElementById('ngayChinhThuc').value,
                    hocVan: document.getElementById('hocVan').value,
                    chinhTri: document.getElementById('chinhTri').value,
                    chuyenMon: document.getElementById('chuyenMon').value,
                    chucVu: document.getElementById('chucVu').value,
                    trangThai: document.getElementById('trangThai').value,
                    ghiChu: document.getElementById('ghiChu').value,
                    receivedMedals: receivedMedals, 
                };

                // KI·ªÇM TRA D·ªÆ LI·ªÜU TR∆Ø·ªöC KHI L∆ØU
                const validationErrors = validateForm(memberData);
                if (validationErrors.length > 0) {
                    alert("Kh√¥ng th·ªÉ l∆∞u! Vui l√≤ng ki·ªÉm tra l·∫°i c√°c l·ªói sau:\n\n" + validationErrors.join("\n"));
                    return; // D·ª´ng h√†m, kh√¥ng cho l∆∞u
                }

                const memberId = document.getElementById('memberId').value;

                if (memberId) {
                    const index = members.findIndex(m => m.id === parseInt(memberId));
                    members[index] = { ...members[index], ...memberData };
                } else {
                    const newId = members.length > 0 ? Math.max(...members.map(m => m.id)) + 1 : 1;
                    members.push({ id: newId, ...memberData });
                }

                saveToLocalStorage();
                applyFiltersAndRender();
                closeModal();
            }

            function validateForm(data) {
                const errors = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0); 

                // 1. Ki·ªÉm tra Ng√†y sinh
                if (data.ngaySinh) {
                    const dob = new Date(data.ngaySinh);
                    if (dob > today) {
                        errors.push("L·ªói: Ng√†y sinh kh√¥ng ƒë∆∞·ª£c ·ªü t∆∞∆°ng lai.");
                    }
                }

                // 2. Ki·ªÉm tra Ng√†y v√†o ƒê·∫£ng
                if (data.ngayVaoDang && data.ngayChinhThuc) {
                    const duBiDate = new Date(data.ngayVaoDang);
                    const chinhThucDate = new Date(data.ngayChinhThuc);
                    if (chinhThucDate <= duBiDate) { 
                        errors.push("L·ªói: Ng√†y ch√≠nh th·ª©c ph·∫£i ·ªü sau ng√†y d·ª± b·ªã.");
                    }
                }

                // 3. Ki·ªÉm tra S·ªë ƒëi·ªán tho·∫°i
                if (data.soDienThoai && data.soDienThoai.trim() !== '') { 
                    const phoneRegex = /^0\d{9}$/;
                    if (!phoneRegex.test(data.soDienThoai)) {
                        errors.push("L·ªói: S·ªë ƒëi·ªán tho·∫°i kh√¥ng h·ª£p l·ªá (ph·∫£i l√† 10 s·ªë, b·∫Øt ƒë·∫ßu b·∫±ng 0).");
                    }
                }
                
                return errors;
            }


            // --- C√ÅC H√ÄM X·ª¨ L√ù MODAL "X√ìA" ---

            function openDeleteModal(id) {
                const member = members.find(m => m.id === id);
                if (!member) return;
                
                itemToDelete = id; 
                deleteModalTitle.textContent = `X√≥a ƒê·∫£ng vi√™n`;
                deleteModalBody.innerHTML = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒê·∫£ng vi√™n: <br><strong class="font-medium text-gray-900">${member.hoTen}</strong>? <br>H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`;
                deleteModal.classList.add('show');
            }

            function openBulkDeleteModal() {
                const selectedCheckboxes = document.querySelectorAll('.member-checkbox:checked');
                const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.id));
                
                if (selectedIds.length === 0) {
                    alert('B·∫°n ch∆∞a ch·ªçn m·ª•c n√†o ƒë·ªÉ x√≥a.');
                    return;
                }
                
                itemToDelete = selectedIds; 
                deleteModalTitle.textContent = `X√≥a h√†ng lo·∫°t`;
                deleteModalBody.innerHTML = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a <strong class="font-medium text-gray-900">${selectedIds.length}</strong> ƒê·∫£ng vi√™n ƒë√£ ch·ªçn? <br>H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`;
                deleteModal.classList.add('show');
            }
            
            function closeDeleteModal() {
                itemToDelete = null; 
                deleteModal.classList.remove('show');
            }
            
            function handleConfirmDelete() {
                if (!itemToDelete) return; 

                if (Array.isArray(itemToDelete)) {
                    const idsToDelete = itemToDelete;
                    members = members.filter(member => !idsToDelete.includes(member.id));
                } else if (typeof itemToDelete === 'number') {
                    const idToDelete = itemToDelete;
                    members = members.filter(member => member.id !== idToDelete);
                }
                
                saveToLocalStorage();
                applyFiltersAndRender();
                closeDeleteModal();
            }

            // --- C√ÅC H√ÄM X·ª¨ L√ù SAO L∆ØU JSON ---

            function exportData() {
                if (!appKey) {
                    alert("Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i ƒë·ªÉ th·ª±c hi·ªán!");
                    return;
                }
                if (members.length === 0) {
                    alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.');
                    return;
                }
                
                const encryptedData = localStorage.getItem('partyMembers_encrypted');
                if (!encryptedData) {
                    alert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ƒë√£ m√£ ho√°. Vui l√≤ng th√™m/s·ª≠a m·ªôt ƒê·∫£ng vi√™n ƒë·ªÉ kh·ªüi t·∫°o l·∫°i.');
                    return;
                }
                
                const dataBlob = new Blob([encryptedData], { type: 'text/plain;charset=utf-8' }); 
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `backup_dangvien_encrypted_${new Date().toISOString().slice(0,10)}.json.txt`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function importData(event) {
                if (!appKey) {
                    alert("Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i ƒë·ªÉ th·ª±c hi·ªán!");
                    return;
                }
                
                const file = event.target.files[0];
                if (!file) return;

                if (!confirm('Vi·ªác n√†y s·∫Ω GHI ƒê√à to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i (n·∫øu m·∫≠t kh·∫©u ƒë√∫ng). B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ti·∫øp t·ª•c?')) {
                    event.target.value = null;
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    let decryptedData = "";
                    const fileContent = e.target.result;
                    
                    try {
                        // Th·ª≠ gi·∫£i m√£ (d√†nh cho file backup m·ªõi .json.txt)
                        const decryptedBytes = CryptoJS.AES.decrypt(fileContent, appKey);
                        decryptedData = decryptedBytes.toString(CryptoJS.enc.Utf8);
                    } catch (e) {
                        // N·∫øu l·ªói, gi·∫£ ƒë·ªãnh ƒë√¢y l√† file JSON c≈© (kh√¥ng m√£ ho√°)
                        console.log("Kh√¥ng th·ªÉ gi·∫£i m√£. Th·ª≠ ƒë·ªçc file d·∫°ng vƒÉn b·∫£n thu·∫ßn...");
                        decryptedData = fileContent;
                    }

                    try {
                        if (!decryptedData) throw new Error("Gi·∫£i m√£ th·∫•t b·∫°i - Sai m·∫≠t kh·∫©u ho·∫∑c t·ªáp l·ªói?");

                        const importedMembers = JSON.parse(decryptedData);
                        
                        if (Array.isArray(importedMembers)) {
                            members = importedMembers;
                            saveToLocalStorage(); // L∆∞u l·∫°i (m√£ ho√° l·∫°i v·ªõi key hi·ªán t·∫°i)
                            applyFiltersAndRender();
                            alert('Nh·∫≠p v√† kh√¥i ph·ª•c d·ªØ li·ªáu th√†nh c√¥ng!');
                        } else {
                            alert('T·ªáp JSON kh√¥ng h·ª£p l·ªá sau khi gi·∫£i m√£.');
                        }
                    } catch (error) {
                        alert('L·ªói khi ƒë·ªçc t·ªáp: ' + error.message);
                        console.error("L·ªói Import:", error);
                    }
                    event.target.value = null;
                };
                reader.readAsText(file);
            }


            // --- H√ÄM TI·ªÜN √çCH CHU·∫®N H√ìA NG√ÄY ---
            function normalizeDate(dateString) {
                if (!dateString) return '';
                
                if (dateString.includes('-') && dateString.split('-').length === 3) {
                    return dateString;
                }

                if (dateString.includes('/')) {
                    const parts = dateString.split('/');
                    if (parts.length === 3) {
                        let [d, m, y] = parts;
                        d = d.padStart(2, '0');
                        m = m.padStart(2, '0');
                        return `${y}-${m}-${d}`;
                    }
                }
                
                return dateString; 
            }

            // --- C√ÅC H√ÄM X·ª¨ L√ù CSV ---

            function downloadFile(content, fileName, mimeType) {
                const bom = "\uFEFF"; 
                const dataBlob = new Blob([bom + content], { type: mimeType });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function escapeCSV(str) {
                if (str === null || str === undefined) return ''; 
                const strString = String(str); 
                if (strString.includes(',') || strString.includes('\n') || strString.includes('"')) {
                    return `"${strString.replace(/"/g, '""')}"`;
                }
                return strString;
            }


            function downloadCsvTemplate() {
                const headers = [
                    'H·ªç t√™n', 'Ng√†y sinh (DD/MM/YYYY)', 'Gi·ªõi t√≠nh (Nam/N·ªØ)', 'Qu√™ qu√°n', 'S·ªë CCCD', 
                    'S·ªë ƒëi·ªán tho·∫°i',
                    'S·ªë th·∫ª ƒê·∫£ng vi√™n', 'Ng√†y v√†o ƒê·∫£ng (DD/MM/YYYY)', 'Ng√†y ch√≠nh th·ª©c (DD/MM/YYYY)', 
                    'Ch·ª©c v·ª•', 'Tr·∫°ng th√°i', 'Ghi ch√∫', 
                    'H·ªçc v·∫•n', 'Ch√≠nh tr·ªã', 'Chuy√™n m√¥n',
                    'Huy hi·ªáu ƒë√£ nh·∫≠n (c√°ch nhau b·∫±ng ;)'
                ];
                let csvContent = headers.join(',') + '\n';
                
                const example = [
                    'Nguy·ªÖn VƒÉn A', '01/01/1990', 'Nam', 'H√† N·ªôi', '001234567890', 
                    '0901234567',
                    '12345678', '01/01/2020', '01/01/2021', 
                    'ƒê·∫£ng vi√™n', 'ƒêang sinh ho·∫°t', 'Ghi ch√∫ v√≠ d·ª•',
                    '12/12', 'Cao c·∫•p', 'K·ªπ s∆∞ CNTT',
                    '30;40'
                ].map(escapeCSV).join(',');
                csvContent += example + '\n';

                downloadFile(csvContent, 'template_nhap_lieu.csv', 'text/csv;charset=utf-8;');
            }

            function exportToCSV() {
                try {
                    if (members.length === 0) {
                        alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t CSV.');
                        return;
                    }
                    
                    const headers = [
                        'ID', 'H·ªç t√™n', 'Ng√†y sinh (DD/MM/YYYY)', 'Gi·ªõi t√≠nh', 'Qu√™ qu√°n', 'S·ªë CCCD', 
                        'S·ªë ƒëi·ªán tho·∫°i',
                        'S·ªë th·∫ª ƒê·∫£ng vi√™n', 'Ng√†y v√†o ƒê·∫£ng (DD/MM/YYYY)', 'Ng√†y ch√≠nh th·ª©c (DD/MM/YYYY)', 
                        'Ch·ª©c v·ª•', 'Tr·∫°ng th√°i', 'Ghi ch√∫', 
                        'H·ªçc v·∫•n', 'Ch√≠nh tr·ªã', 'Chuy√™n m√¥n',
                        'Huy hi·ªáu ƒë√£ nh·∫≠n'
                    ];
                    let csvContent = headers.join(',') + '\n';

                    members.forEach(m => {
                        const row = [
                            m.id,
                            m.hoTen,
                            formatDate(m.ngaySinh),
                            m.gioiTinh,
                            m.queQuan,
                            m.cccd,
                            m.soDienThoai, 
                            m.soTheDang,
                            formatDate(m.ngayVaoDang),
                            formatDate(m.ngayChinhThuc),
                            m.chucVu,
                            m.trangThai,
                            m.ghiChu,
                            m.hocVan, m.chinhTri, m.chuyenMon,
                            (m.receivedMedals || []).join(';') 
                        ].map(escapeCSV);
                        csvContent += row.join(',') + '\n';
                    });

                    downloadFile(csvContent, `danhsach_dangvien_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
                } catch (error) {
                    alert('L·ªñI XU·∫§T CSV: ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i. L·ªói: ' + error.message);
                    console.error("Export CSV Error:", error); 
                }
            }


            function importFromCSV(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!confirm('Vi·ªác n√†y s·∫Ω *TH√äM* d·ªØ li·ªáu t·ª´ file CSV v√†o danh s√°ch hi·ªán t·∫°i. (S·∫Ω kh√¥ng x√≥a d·ªØ li·ªáu c≈©). B·∫°n c√≥ ch·∫Øc ch·∫Øn?')) {
                    event.target.value = null; 
                    return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n');
                        
                        if (lines.length <= 1) {
                            alert('T·ªáp CSV tr·ªëng ho·∫∑c kh√¥ng h·ª£p l·ªá.');
                            return;
                        }

                        let maxId = members.length > 0 ? Math.max(...members.map(m => m.id)) : 0;
                        let addedCount = 0;

                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (line === '') continue; 

                            const values = line.split(','); 
                            
                            if (values.length < 16) {
                                console.warn(`B·ªè qua d√≤ng ${i+1}: Kh√¥ng ƒë·ªß 16 c·ªôt. (T√¨m th·∫•y ${values.length})`);
                                continue; 
                            }
                            
                            const receivedString = values[15].trim().replace(/"/g, ''); 
                            const receivedMedals = receivedString === '' ? [] : receivedString.split(';').map(s => parseInt(s.trim())).filter(Number.isInteger);

                            const memberData = {
                                hoTen: values[0].trim(),
                                ngaySinh: normalizeDate(values[1].trim()),
                                gioiTinh: values[2].trim(),
                                queQuan: values[3].trim(),
                                cccd: values[4].trim(),
                                soDienThoai: values[5].trim(), 
                                soTheDang: values[6].trim(),
                                ngayVaoDang: normalizeDate(values[7].trim()),
                                ngayChinhThuc: normalizeDate(values[8].trim()),
                                chucVu: values[9].trim(),
                                trangThai: values[10].trim(),
                                ghiChu: values[11].trim(),
                                hocVan: values[12].trim(),
                                chinhTri: values[13].trim(),
                                chuyenMon: values[14].trim(),
                                receivedMedals: receivedMedals 
                            };

                            if (!memberData.hoTen || !memberData.ngaySinh || !memberData.ngayVaoDang) { 
                                console.warn(`B·ªè qua d√≤ng ${i+1}: Thi·∫øu H·ªç t√™n, Ng√†y sinh ho·∫∑c Ng√†y v√†o ƒê·∫£ng (D·ª± b·ªã).`);
                                continue;
                            }

                            maxId++;
                            members.push({ id: maxId, ...memberData });
                            addedCount++;
                        }

                        saveToLocalStorage();
                        applyFiltersAndRender();
                        alert(`ƒê√£ th√™m th√†nh c√¥ng ${addedCount} ƒê·∫£ng vi√™n t·ª´ t·ªáp CSV.`);
                    } catch (error) {
                        alert('L·ªói khi ƒë·ªçc t·ªáp CSV: ' + error.message);
                    }
                    event.target.value = null; 
                };
                reader.readAsText(file, 'UTF-8'); 
            }

            // --- C√ÅC H√ÄM X·ª¨ L√ù X√ìA H√ÄNG LO·∫†T ---

            function updateBulkDeleteButtonState() {
                const selectedCheckboxes = document.querySelectorAll('.member-checkbox:checked');
                const selectedCount = selectedCheckboxes.length;
                
                if (selectedCount > 0) {
                    bulkDeleteBtn.disabled = false;
                    bulkDeleteBtn.textContent = `X√≥a m·ª•c ƒë√£ ch·ªçn (${selectedCount})`;
                } else {
                    bulkDeleteBtn.disabled = true;
                    bulkDeleteBtn.textContent = 'X√≥a m·ª•c ƒë√£ ch·ªçn (0)';
                }

                const totalCheckboxes = document.querySelectorAll('.member-checkbox').length;
                selectAllCheckbox.checked = (totalCheckboxes > 0 && selectedCount === totalCheckboxes);
            }

            function handleSelectAll(event) {
                const isChecked = event.target.checked;
                const allCheckboxes = document.querySelectorAll('.member-checkbox');
                allCheckboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
                updateBulkDeleteButtonState();
            }

            // --- H√ÄM IN ·∫§N ---
            function printMemberDetails() {
                if (memberToPrint === null) return;
                const member = members.find(m => m.id === memberToPrint);
                if (!member) return;

                const tuoiDoi = getTuoiDoi(member.ngaySinh);
                const partyAge = getTuoiDang(member.ngayVaoDang);
                const received = member.receivedMedals || [];
                const receivedText = received.length > 0 ? received.join(', ') + ' nƒÉm' : 'Ch∆∞a nh·∫≠n';

                // T·∫°o n·ªôi dung HTML cho trang in
                const printContent = `
                    <html>
                        <head>
                            <title>H·ªì s∆° ƒê·∫£ng vi√™n: ${member.hoTen}</title>
                            <style>
                                body { 
                                    font-family: 'Times New Roman', Times, serif; 
                                    margin: 2cm; 
                                    font-size: 13pt;
                                    line-height: 1.5;
                                }
                                .photo-placeholder {
                                    float: left;
                                    width: 4cm;
                                    height: 6cm;
                                    border: 2px solid #000;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    color: #aaa;
                                    font-size: 11pt;
                                    font-style: italic;
                                    box-sizing: border-box;
                                }
                                .header-content {
                                    margin-left: 5cm; /* 4cm box + 1cm margin */
                                    padding-top: 1cm;
                                    text-align: center;
                                }
                                .header-content h1 {
                                    font-size: 16pt; 
                                    font-weight: bold; 
                                    text-transform: uppercase;
                                    margin: 5px 0;
                                }
                                .header-content h3 {
                                    font-size: 14pt;
                                    font-weight: normal;
                                    margin: 0;
                                }
                                .header-content h4 {
                                    font-size: 13pt;
                                    font-weight: bold;
                                    margin: 0;
                                }
                                .clear-float {
                                    clear: both;
                                }
                                h2 { 
                                    font-size: 14pt;
                                    font-weight: bold;
                                    border-bottom: 1px solid #000;
                                    padding-bottom: 5px;
                                    margin-top: 20px;
                                    margin-bottom: 15px;
                                }
                                table {
                                    width: 100%;
                                    border-collapse: collapse;
                                }
                                td {
                                    padding: 8px 0;
                                    vertical-align: top;
                                    border-bottom: 1px dashed #ccc;
                                }
                                td:first-child {
                                    font-weight: bold;
                                    width: 35%;
                                }
                                table tr:last-child td {
                                    border-bottom: none;
                                }
                            </style>
                        </head>
                        <body>
                            <div class="photo-placeholder">·∫¢nh 4x6</div>
                            <div class="header-content">
                                <h3>ƒê·∫¢NG ·ª¶Y PH∆Ø·ªúNG LONG XUY√äN</h3>
                                <h4>CHI B·ªò KH√ìM ƒê√îNG AN</h4>
                                <h1>H·ªì s∆° ƒê·∫£ng vi√™n</h1>
                            </div>
                            <div class="clear-float"></div>

                            <h2>I. Th√¥ng tin c√° nh√¢n</h2>
                            <table>
                                <tr>
                                    <td>H·ªç v√† t√™n:</td>
                                    <td>${member.hoTen}</td>
                                </tr>
                                <tr>
                                    <td>Ng√†y sinh (Tu·ªïi ƒë·ªùi):</td>
                                    <td>${formatDate(member.ngaySinh)} (${tuoiDoi} tu·ªïi)</td>
                                </tr>
                                <tr>
                                    <td>Gi·ªõi t√≠nh:</td>
                                    <td>${member.gioiTinh}</td>
                                </tr>
                                <tr>
                                    <td>Qu√™ qu√°n:</td>
                                    <td>${member.queQuan || 'Ch∆∞a c·∫≠p nh·∫≠t'}</td>
                                </tr>
                                <tr>
                                    <td>S·ªë CCCD:</td>
                                    <td>${member.cccd || 'Ch∆∞a c·∫≠p nh·∫≠t'}</td>
                                </tr>
                                <tr>
                                    <td>S·ªë ƒëi·ªán tho·∫°i:</td>
                                    <td>${member.soDienThoai || 'Ch∆∞a c·∫≠p nh·∫≠t'}</td>
                                </tr>
                            </table>

                            <h2>II. Tr√¨nh ƒë·ªô</h2>
                            <table>
                                <tr>
                                    <td>H·ªçc v·∫•n:</td>
                                    <td>${member.hocVan || 'Ch∆∞a c·∫≠p nh·∫≠t'}</td>
                                </tr>
                                <tr>
                                    <td>L√Ω lu·∫≠n Ch√≠nh tr·ªã:</td>
                                    <td>${member.chinhTri || 'Ch∆∞a c·∫≠p nh·∫≠t'}</td>
                                </tr>
                                <tr>
                                    <td>Chuy√™n m√¥n:</td>
                                    <td>${member.chuyenMon || 'Ch∆∞a c·∫≠p nh·∫≠t'}</td>
                                </tr>
                            </table>

                            <h2>III. Th√¥ng tin ƒê·∫£ng</h2>
                            <table>
                                <tr>
                                    <td>S·ªë th·∫ª ƒê·∫£ng vi√™n:</td>
                                    <td>${member.soTheDang || 'Ch∆∞a c·∫≠p nh·∫≠t'}</td>
                                </tr>
                                <tr>
                                    <td>Ng√†y v√†o ƒê·∫£ng (D·ª± b·ªã):</td>
                                    <td>${formatDate(member.ngayVaoDang)}</td>
                                </tr>
                                <tr>
                                    <td>Ng√†y v√†o ƒê·∫£ng (Ch√≠nh th·ª©c):</td>
                                    <td>${formatDate(member.ngayChinhThuc)}</td>
                                </tr>
                                <tr>
                                    <td>Tu·ªïi ƒê·∫£ng (hi·ªán t·∫°i):</td>
                                    <td>${partyAge} nƒÉm (T√≠nh t·ª´ ng√†y d·ª± b·ªã)</td>
                                </tr>
                                <tr>
                                    <td>Huy hi·ªáu ƒë√£ nh·∫≠n:</td>
                                    <td>${receivedText}</td>
                                </tr>
                                <tr>
                                    <td>Ch·ª©c v·ª•:</td>
                                    <td>${member.chucVu || 'ƒê·∫£ng vi√™n'}</td>
                                </tr>
                                <tr>
                                    <td>Tr·∫°ng th√°i:</td>
                                    <td>${member.trangThai}</td>
                                </tr>
                                <tr>
                                    <td>Ghi ch√∫:</td>
                                    <td>${member.ghiChu || 'Kh√¥ng c√≥'}</td>
                                </tr>
                            </table>

                        </body>
                    </html>
                `;
                
                // M·ªü c·ª≠a s·ªï m·ªõi v√† in
                const printWindow = window.open('', '_blank');
                printWindow.document.open();
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.focus(); 
                printWindow.print();
                printWindow.close();
            }


            // --- H√ÄM TI·ªÜN √çCH (formatDate) ---
            function formatDate(dateString) {
                if (!dateString) return '';
                try {
                    const [y, m, d] = dateString.split('-');
                    if (y && m && d) {
                        return `${d}/${m}/${y}`;
                    }
                    return dateString;
                } catch (e) {
                    return dateString;
                }
            }
            
            function initializeForm() {
                // T·∫°o c√°c checkbox Huy hi·ªáu trong form
                ALL_MILESTONES.forEach(year => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-2 text-sm cursor-pointer';
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.className = 'received-medal form-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500';
                    input.value = year;
                    label.appendChild(input);
                    label.appendChild(document.createTextNode(`${year} nƒÉm`));
                    receivedMedalCheckboxes.appendChild(label);
                });
            }

            // H√ÄM X·ª¨ L√ù ƒêƒÇNG NH·∫¨P
            function handleLoginAttempt() {
                const password = passwordInput.value;
                if (!password) {
                    alert("Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u.");
                    return;
                }
                
                appKey = password; // ƒê·∫∑t ch√¨a kho√°
                
                const success = loadFromLocalStorage(); // Th·ª≠ gi·∫£i m√£ (ho·∫∑c di chuy·ªÉn)
                
                if (success) {
                    // M·∫≠t kh·∫©u ƒë√∫ng (ho·∫∑c l·∫ßn ƒë·∫ßu / di chuy·ªÉn th√†nh c√¥ng) -> M·ªü kho√° ·ª©ng d·ª•ng
                    authModal.classList.remove('show');
                    appContainer.classList.add('unlocked');
                    
                    // T·∫£i ·ª©ng d·ª•ng
                    applyFiltersAndRender();
                    
                    // T·ª± ƒë·ªông m·ªü H∆∞·ªõng d·∫´n n·∫øu ch∆∞a c√≥ d·ªØ li·ªáu V√Ä kh√¥ng ph·∫£i l√† v·ª´a di chuy·ªÉn
                    const encryptedData = localStorage.getItem('partyMembers_encrypted');
                    if (members.length === 0 && !encryptedData) { // Ch·ªâ hi·ªán khi DB tr·ªëng r·ªóng
                        setTimeout(() => {
                            helpModal.classList.add('show');
                        }, 500); 
                    }
                } else {
                    // M·∫≠t kh·∫©u sai
                    alert("M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng! Vui l√≤ng th·ª≠ l·∫°i.");
                    appKey = null; // Reset ch√¨a kho√°
                    passwordInput.value = ""; // X√≥a √¥ m·∫≠t kh·∫©u
                }
            }


            // --- G√ÅN S·ª∞ KI·ªÜN (EVENT LISTENERS) ---
            addMemberBtn.addEventListener('click', () => openModal());
            cancelBtn.addEventListener('click', closeModal);
            memberForm.addEventListener('submit', handleFormSubmit);

            closeViewModalBtn.addEventListener('click', closeViewModal);
            printMemberBtn.addEventListener('click', printMemberDetails); 

            memberTableBody.addEventListener('click', (event) => {
                if (event.target.classList.contains('view-btn')) {
                    const id = parseInt(event.target.dataset.id);
                    openViewModal(id);
                }
                if (event.target.classList.contains('edit-btn')) {
                    const id = parseInt(event.target.dataset.id);
                    openModal(id);
                }
                if (event.target.classList.contains('delete-btn')) {
                    const id = parseInt(event.target.dataset.id);
                    openDeleteModal(id);
                }
            });

            memberTableBody.addEventListener('change', (event) => {
                if (event.target.classList.contains('member-checkbox')) {
                    updateBulkDeleteButtonState();
                }
            });

            // X·ª≠ l√Ω Menu L·ªçc
            filterMenuBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                filterMenu.classList.toggle('show');
            });

            window.addEventListener('click', (e) => {
                if (!filterMenu.contains(e.target) && !filterMenuBtn.contains(e.target)) {
                    filterMenu.classList.remove('show');
                }
            });

            filterMenu.addEventListener('change', (e) => {
                if (e.target.name === 'sort') {
                    currentSort = e.target.value;
                }
                if (e.target.name === 'gender') {
                    currentGenderFilter = e.target.value;
                }
                if (e.target.name === 'medal') {
                    currentMedalFilter = e.target.value;
                }
                
                currentPage = 1; 
                applyFiltersAndRender();
            });


            // L·ªçc & Ph√¢n trang
            searchInput.addEventListener('input', () => {
                currentPage = 1;
                applyFiltersAndRender();
            });
            itemsPerPageSelect.addEventListener('change', () => {
                currentPage = 1;
                applyFiltersAndRender();
            });

            paginationControls.addEventListener('click', (event) => {
                const target = event.target.closest('button');
                if (!target) return; 
                
                const action = target.dataset.page;
                let pageChanged = false;

                if (action === 'prev' && currentPage > 1) {
                    currentPage--;
                    pageChanged = true;
                } else if (action === 'next' && currentPage < totalPages) {
                    currentPage++;
                    pageChanged = true;
                } else if (!isNaN(action)) {
                    const newPage = parseInt(action);
                    if (newPage !== currentPage) {
                        currentPage = newPage;
                        pageChanged = true;
                    }
                }

                if (pageChanged) {
                    applyFiltersAndRender();
                }
            });

            // Sao l∆∞u
            exportBtn.addEventListener('click', exportData);
            importInput.addEventListener('change', importData);
            downloadCsvTemplateBtn.addEventListener('click', downloadCsvTemplate);
            importCsvInput.addEventListener('change', importFromCSV);
            exportCsvBtn.addEventListener('click', exportToCSV); 
            selectAllCheckbox.addEventListener('change', handleSelectAll);
            
            // N√∫t X√≥a h√†ng lo·∫°t
            bulkDeleteBtn.addEventListener('click', openBulkDeleteModal);

            // N√∫t trong Modal X√≥a
            cancelDeleteBtn.addEventListener('click', closeDeleteModal);
            confirmDeleteBtn.addEventListener('click', handleConfirmDelete);
            
            // N√∫t trong Modal H∆∞·ªõng d·∫´n
            helpBtn.addEventListener('click', () => helpModal.classList.add('show'));
            closeHelpModalBtn.addEventListener('click', () => helpModal.classList.remove('show'));
            
            // N√∫t trong Modal ƒêƒÉng nh·∫≠p
            loginBtn.addEventListener('click', handleLoginAttempt);
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    handleLoginAttempt();
                }
            });


            // --- KH·ªûI CH·∫†Y ·ª®NG D·ª§NG ---
            initializeForm(); // T·∫°o c√°c checkbox huy hi·ªáu
            
            // Hi·ªÉn th·ªã modal ƒëƒÉng nh·∫≠p
            authModal.classList.add('show');
            passwordInput.focus();
        });
    </script>
</body>
</html>