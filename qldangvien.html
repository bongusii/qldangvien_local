<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Đảng viên</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>
    <style>
        /* (CẬP NHẬT) Thêm #changePasswordModal */
        #memberModal, #viewModal, #deleteModal, #helpModal, #authModal, #statsModal, #changePasswordModal { 
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        #memberModal.show, #viewModal.show, #deleteModal.show, #helpModal.show, #authModal.show, #statsModal.show, #changePasswordModal.show { 
            display: flex;
            opacity: 1;
        }
        /* FIX: Đảm bảo cả hai menu lọc đều bị ẩn ban đầu bởi CSS custom */
        #filterMenu, #filterMenu213 {
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
        }
        #filterMenu.show, #filterMenu213.show {
            display: block !important; /* FIX: BẮT BUỘC HIỂN THỊ ĐỂ GHI ĐÈ TAILWIND/CONFLICT */
            opacity: 1;
        }
        #helpModalContent::-webkit-scrollbar, #statsModalContent::-webkit-scrollbar {
            width: 8px;
        }
        #helpModalContent::-webkit-scrollbar-thumb, #statsModalContent::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        #helpModalContent::-webkit-scrollbar-track, #statsModalContent::-webkit-scrollbar-track {
            background-color: #f1f5f9;
        }
        
        #appContainer {
            display: none; /* Ẩn ban đầu */
        }
        #appContainer.unlocked {
            display: block; /* Hiện khi đã đăng nhập */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8 flex flex-col min-h-screen antialiased">
    
    <div id="authModal" class="fixed inset-0 bg-gray-900 bg-opacity-90 overflow-y-auto h-full w-full items-center justify-center p-4 z-50">
        <div class="relative mx-auto w-full max-w-sm shadow-lg rounded-lg bg-white">
            <div class="p-6">
                <h3 class="text-2xl text-center leading-6 font-bold text-gray-900 mb-4">Đã khoá</h3>
                <p class="text-center text-sm text-gray-500 mb-6">Vui lòng nhập mật khẩu để mở khoá dữ liệu. <br>(Nếu đây là lần đầu, mật khẩu bạn nhập sẽ là mật khẩu mới).</p>
                
                <div class="space-y-4">
                    <div>
                        <label for="passwordInput" class="block text-sm font-medium text-gray-700">Mật khẩu</label>
                        <input type="password" id="passwordInput" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" autofocus>
                    </div>
                    <button id="loginBtn" class="w-full py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500">
                        Mở khoá
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="appContainer">
        <div class="container mx-auto max-w-7xl bg-white shadow-lg rounded-lg p-4 md:p-6 flex-grow">
            
            <h1 class="text-2xl md:text-3xl font-bold text-center text-red-700 mb-6">
                Hệ thống Quản lý Đảng viên
            </h1>
            
            <div id="appTabs" class="flex border-b border-gray-200 mb-6">
                <button data-tab="main" class="tab-button py-2 px-4 text-sm font-medium border-b-2 border-red-700 text-red-700 bg-red-50 transition-colors duration-150">
                    Đảng viên Chính thức
                </button>
                <button data-tab="213" class="tab-button py-2 px-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-red-700 hover:border-red-500 transition-colors duration-150">
                    Đảng viên 213 (Cư trú)
                </button>
            </div>
            <div id="mainMemberContainer" class="tab-content active">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg shadow-sm border border-blue-200">
                        <h3 class="text-sm font-medium text-blue-800">Tổng số Đảng viên</h3>
                        <p id="statTotal" class="text-3xl font-bold text-blue-900">0</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg shadow-sm border border-green-200">
                        <h3 class="text-sm font-medium text-green-800">Nam</h3>
                        <p id="statMale" class="text-3xl font-bold text-green-900">0</p>
                    </div>
                    <div class="bg-pink-50 p-4 rounded-lg shadow-sm border border-pink-200">
                        <h3 class="text-sm font-medium text-pink-800">Nữ</h3>
                        <p id="statFemale" class="text-3xl font-bold text-pink-900">0</p>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg shadow-sm border border-yellow-200">
                        <h3 class="text-sm font-medium text-yellow-800">Sắp nhận Huy hiệu</h3>
                        <p id="statMedal" class="text-3xl font-bold text-yellow-900">0</p>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div class="flex gap-2">
                        <button id="addMemberBtn" title="Thêm Đảng viên mới" class="py-2 px-3 rounded-full font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5V4.75z" />
                            </svg>
                        </button>
                        <button id="bulkDeleteBtn" title="Xóa mục đã chọn" class="py-2 px-3 rounded-full font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-red-600 text-white hover:bg-red-700 focus:ring-red-500 flex items-center gap-2 hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                            </svg>
                            <span id="bulkDeleteCount">(0)</span>
                        </button>
                    </div>
                    
                    <div class="flex flex-wrap gap-2 justify-end items-center">
                        <button id="changePasswordBtn" title="Đổi mật khẩu" class="p-2 rounded-full font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-yellow-400 text-white hover:bg-yellow-500 focus:ring-yellow-300">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3.5 8H6.5V5.5a3.5 3.5 0 117 0V9zM12 11a1 1 0 100 2 1 1 0 000-2z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <button id="statsBtn" title="Xem Thống kê" class="p-2 rounded-full font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-gray-200 text-gray-700 hover:bg-gray-300 focus:ring-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" />
                                <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" />
                            </svg>
                        </button>
                        <button id="helpBtn" title="Xem Hướng dẫn" class="p-2 rounded-full font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-gray-200 text-gray-700 hover:bg-gray-300 focus:ring-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM8.94 6.94a.75.75 0 11-1.06-1.061 3.5 3.5 0 014.59.815.75.75 0 01-1.22.872A2 2 0 009.25 7.75v.25a.75.75 0 01-1.5 0v-.25c0-.553.224-1.054.59-1.41zM9 10a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 019 10z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        
                        <span class="border-l border-gray-300 h-6 mx-1"></span>

                        <button id="exportBtn" title="Xuất JSON (Backup)" class="p-2 rounded-full font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-green-600 text-white hover:bg-green-700 focus:ring-green-500">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.23a.75.75 0 00-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.134V2.75z" />
                                <path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5a1.25 1.25 0 01-1.25 1.25H4.75A1.25 1.25 0 013.5 15.25v-2.5z" />
                            </svg>
                        </button>
                        <label title="Nhập JSON (Restore)" class="p-2 rounded-full font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-yellow-500 text-white hover:bg-yellow-600 focus:ring-yellow-400 cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path d="M9.25 13.75a.75.75 0 001.5 0V5.136l2.955 3.134a.75.75 0 001.09-1.03l-4.25-4.5a.75.75 0 00-1.09 0l-4.25 4.5a.75.75 0 001.09 1.03l2.955-3.134v8.614z" />
                                <path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5a1.25 1.25 0 01-1.25 1.25H4.75A1.25 1.25 0 013.5 15.25v-2.5z" />
                            </svg>
                            <input type="file" id="importInput" class="hidden" accept=".json,.txt">
                        </label>
                        <button id="downloadCsvTemplateBtn" title="Tải CSV mẫu" class="p-2 rounded-full font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-gray-500 text-white hover:bg-gray-600 focus:ring-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.25a.75.75 0 00-1.5 0v4.59L7.3 9.7a.75.75 0 00-1.1 1.02l3.25 3.5a.75.75 0 001.1 0l3.25-3.5a.75.75 0 10-1.1-1.02l-1.95 2.1V6.75z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <label title="Nhập từ CSV" class="p-2 rounded-full font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-cyan-600 text-white hover:bg-cyan-700 focus:ring-cyan-500 cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-.75-4.75a.75.75 0 001.5 0V8.66l1.95 2.1a.75.75 0 101.1-1.02l-3.25-3.5a.75.75 0 00-1.1 0L6.2 9.74a.75.75 0 101.1 1.02l1.95-2.1v4.59z" clip-rule="evenodd" />
                            </svg>
                            <input type="file" id="importCsvInput" class="hidden" accept=".csv">
                        </label>
                        <button id="exportCsvBtn" title="Xuất ra CSV" class="p-2 rounded-full font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-teal-600 text-white hover:bg-teal-700 focus:ring-teal-500">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path fill-rule="evenodd" d="M5 2a.75.75 0 01.75.75v.5c0 .414.336.75.75.75h6A.75.75 0 0113.25 4v-.5a.75.75 0 011.5 0v.5A2.25 2.25 0 0112.5 6h-6A2.25 2.25 0 014.25 4v-.5A.75.75 0 015 2z" clip-rule="evenodd" />
                                <path fill-rule="evenodd" d="M2 7a2 2 0 012-2h12a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V7zm3 4a.75.75 0 01.75-.75h.01a.75.75 0 01.75.75v.01a.75.75 0 01-.75.75h-.01a.75.75 0 01-.75-.75V11zm2.25-.75a.75.75 0 00-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 00.75-.75V11a.75.75 0 00-.75-.75h-.01zM11 11.75a.75.75 0 01.75-.75h.01a.75.75 0 01.75.75v.01a.75.75 0 01-.75.75h-.01a.75.75 0 01-.75-.75V11.75zM8.25 13a.75.75 0 01.75-.75h.01a.75.75 0 01.75.75v.01a.75.75 0 01-.75.75h-.01a.75.75 0 01-.75-.75V13zm3-1.75a.75.75 0 00-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 00.75-.75V12a.75.75 0 00-.75-.75h-.01zM6 13.75a.75.75 0 01.75-.75h.01a.75.75 0 01.75.75v.01a.75.75 0 01-.75.75h-.01a.75.75 0 01-.75-.75V13.75zM13.25 11a.75.75 0 00-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 00.75-.75V11a.75.75 0 00-.75-.75h-.01zM14 13.75a.75.75 0 01.75-.75h.01a.75.75 0 01.75.75v.01a.75.75 0 01-.75.75h-.01a.75.75 0 01-.75-.75V13.75z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                    <input type="text" id="searchInput" placeholder="Tìm kiếm theo Tên, Quê quán, SĐT, CCCD..." class="border-gray-300 rounded-md shadow-sm p-2 w-full col-span-1 md:col-span-4">
                    
                    <div class="relative col-span-1">
                        <button id="filterMenuBtn" class="w-full py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-white text-gray-700 hover:bg-gray-50 border border-gray-300 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path fill-rule="evenodd" d="M2.628 1.601C5.028 1.206 7.49 1 10 1s4.973.206 7.372.601a.75.75 0 01.628.74v2.288a2.25 2.25 0 01-.659 1.59l-4.682 4.683a2.25 2.25 0 00-.659 1.59v3.037c0 .684-.31 1.33-.844 1.757l-1.937 1.55A.75.75 0 0110 18v-5.964a2.25 2.25 0 00-.659-1.59L4.659 5.77A2.25 2.25 0 014 4.18V2.34a.75.75 0 01.628-.74z" clip-rule="evenodd" />
                            </svg>
                            Sắp xếp & Lọc
                        </button>
                        
                        <div id="filterMenu" class="absolute right-0 mt-2 w-72 bg-white border border-gray-200 rounded-lg shadow-xl z-10">
                            <div class="p-4 space-y-4">
                                <div>
                                    <h4 class="text-sm font-semibold text-gray-500 uppercase mb-2">Sắp xếp theo</h4>
                                    <div class="space-y-1">
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="sort" value="partyAge_desc" class="form-radio text-blue-600" checked>
                                            <span class="text-sm">Tuổi Đảng (Cao ➔ Thấp)</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="sort" value="partyAge_asc" class="form-radio text-blue-600">
                                            <span class="text-sm">Tuổi Đảng (Thấp ➔ Cao)</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="sort" value="name_asc" class="form-radio text-blue-600">
                                            <span class="text-sm">Họ tên (A ➔ Z)</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="sort" value="name_desc" class="form-radio text-blue-600">
                                            <span class="text-sm">Họ tên (Z ➔ A)</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <hr class="border-gray-200">
                                
                                <div>
                                    <h4 class="text-sm font-semibold text-gray-500 uppercase mb-2">Lọc theo Giới tính</h4>
                                    <div class="space-y-1">
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="gender" value="all" class="form-radio text-blue-600" checked>
                                            <span class="text-sm">Tất cả</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="gender" value="Nam" class="form-radio text-blue-600">
                                            <span class="text-sm">Nam</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="gender" value="Nữ" class="form-radio text-blue-600">
                                            <span class="text-sm">Nữ</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <hr class="border-gray-200">
                                
                                <div>
                                    <h4 class="text-sm font-semibold text-gray-500 uppercase mb-2">Lọc theo Huy hiệu</h4>
                                    <div class="space-y-1">
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="medal" value="all" class="form-radio text-blue-600" checked>
                                            <span class="text-sm">Tất cả</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="medal" value="upcoming" class="form-radio text-blue-600">
                                            <span class="text-sm">Sắp nhận Huy hiệu</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto border border-gray-200 rounded-lg shadow-sm">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="py-3 px-4 border-b border-gray-600 w-12">
                                    <input type="checkbox" id="selectAllCheckbox" title="Chọn tất cả" class="rounded border-gray-400 text-blue-500 focus:ring-blue-500">
                                </th>
                                <th class="py-3 px-4 border-b border-gray-600 text-center">ID</th>
                                <th class="py-3 px-4 border-b border-gray-600 text-left">Họ tên</th>
                                <th class="py-3 px-4 border-b border-gray-600 text-center">Tuổi Đảng</th>
                                <th class="py-3 px-4 border-b border-gray-600 text-center">Huy hiệu sắp tới</th>
                                <th class="py-3 px-4 border-b border-gray-600 text-center">Trạng thái</th>
                                <th class="py-3 px-4 border-b border-gray-600 text-center">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="memberTableBody">
                            </tbody>
                    </table>
                </div>

                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mt-6">
                    <div>
                        <select id="itemsPerPageSelect" class="border-gray-300 rounded-md shadow-sm p-2 text-sm">
                            <option value="10">Hiển thị 10/trang</option>
                            <option value="20">Hiển thị 20/trang</option>
                            <option value="50">Hiển thị 50/trang</option>
                            <option value="100">Hiển thị 100/trang</option>
                        </select>
                    </div>
                    <div id="paginationControls" class="flex justify-center items-center gap-1">
                    </div>
                </div>
            </div>
            <div id="member213Container" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-purple-50 p-4 rounded-lg shadow-sm border border-purple-200">
                        <h3 class="text-sm font-medium text-purple-800">Tổng số ĐV 213</h3>
                        <p id="stat213Total" class="text-3xl font-bold text-purple-900">0</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-sm font-medium text-gray-800">Nam</h3>
                        <p id="stat213Male" class="text-3xl font-bold text-gray-900">0</p>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg shadow-sm border border-red-200">
                        <h3 class="text-sm font-medium text-red-800">Nữ</h3>
                        <p id="stat213Female" class="text-3xl font-bold text-red-900">0</p>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg shadow-sm border border-orange-200">
                        <h3 class="text-sm font-medium text-orange-800">Sắp nhận Huy hiệu</h3>
                        <p id="stat213Medal" class="text-3xl font-bold text-orange-900">0</p>
                    </div>
                </div>

                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <div class="flex gap-2">
                        <button id="addMember213Btn" title="Thêm Đảng viên 213 mới" class="py-2 px-3 rounded-full font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-purple-600 text-white hover:bg-purple-700 focus:ring-purple-500 flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5V4.75z" />
                            </svg>
                        </button>
                        <button id="bulkDelete213Btn" title="Xóa mục đã chọn (213)" class="py-2 px-3 rounded-full font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-red-600 text-white hover:bg-red-700 focus:ring-red-500 flex items-center gap-2 hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path d="M6.28 5.22a.75.75 0 00-1.06 1.06L8.94 10l-3.72 3.72a.75.75 0 101.06 1.06L10 11.06l3.72 3.72a.75.75 0 101.06-1.06L11.06 10l3.72-3.72a.75.75 0 00-1.06-1.06L10 8.94 6.28 5.22z" />
                            </svg>
                            <span id="bulkDelete213Count">(0)</span>
                        </button>
                    </div>
                    
                    <div class="flex flex-wrap gap-2 justify-end items-center">
                        <button id="stats213Btn" title="Xem Thống kê 213" class="p-2 rounded-full font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-gray-200 text-gray-700 hover:bg-gray-300 focus:ring-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z" />
                                <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z" />
                            </svg>
                        </button>
                        
                        <span class="border-l border-gray-300 h-6 mx-1"></span>

                        <button id="export213Btn" title="Xuất JSON 213 (Backup)" class="p-2 rounded-full font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-green-600 text-white hover:bg-green-700 focus:ring-green-500">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path d="M10.75 2.75a.75.75 0 00-1.5 0v8.614L6.295 8.23a.75.75 0 00-1.09 1.03l4.25 4.5a.75.75 0 001.09 0l4.25-4.5a.75.75 0 00-1.09-1.03l-2.955 3.134V2.75z" />
                                <path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5a1.25 1.25 0 01-1.25 1.25H4.75A1.25 1.25 0 013.5 15.25v-2.5z" />
                            </svg>
                        </button>
                        <label title="Nhập JSON 213 (Restore)" class="p-2 rounded-full font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-yellow-500 text-white hover:bg-yellow-600 focus:ring-yellow-400 cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path d="M9.25 13.75a.75.75 0 001.5 0V5.136l2.955 3.134a.75.75 0 001.09-1.03l-4.25-4.5a.75.75 0 00-1.09 0l-4.25 4.5a.75.75 0 001.09 1.03l2.955-3.134v8.614z" />
                                <path d="M3.5 12.75a.75.75 0 00-1.5 0v2.5A2.75 2.75 0 004.75 18h10.5A2.75 2.75 0 0018 15.25v-2.5a.75.75 0 00-1.5 0v2.5a1.25 1.25 0 01-1.25 1.25H4.75A1.25 1.25 0 013.5 15.25v-2.5z" />
                            </svg>
                            <input type="file" id="import213Input" class="hidden" accept=".json,.txt">
                        </label>
                        <button id="downloadCsvTemplate213Btn" title="Tải CSV mẫu 213" class="p-2 rounded-full font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-gray-500 text-white hover:bg-gray-600 focus:ring-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm.75-11.25a.75.75 0 00-1.5 0v4.59L7.3 9.7a.75.75 0 00-1.1 1.02l3.25 3.5a.75.75 0 001.1 0l3.25-3.5a.75.75 0 10-1.1-1.02l-1.95 2.1V6.75z" clip-rule="evenodd" />
                            </svg>
                        </button>
                        <label title="Nhập từ CSV 213" class="p-2 rounded-full font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-cyan-600 text-white hover:bg-cyan-700 focus:ring-cyan-500 cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm-.75-4.75a.75.75 0 001.5 0V8.66l1.95 2.1a.75.75 0 101.1-1.02l-3.25-3.5a.75.75 0 00-1.1 0L6.2 9.74a.75.75 0 101.1 1.02l1.95-2.1v4.59z" clip-rule="evenodd" />
                            </svg>
                            <input type="file" id="importCsv213Input" class="hidden" accept=".csv">
                        </label>
                        <button id="exportCsv213Btn" title="Xuất ra CSV 213" class="p-2 rounded-full font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-teal-600 text-white hover:bg-teal-700 focus:ring-teal-500">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path fill-rule="evenodd" d="M5 2a.75.75 0 01.75.75v.5c0 .414.336.75.75.75h6A.75.75 0 0113.25 4v-.5a.75.75 0 011.5 0v.5A2.25 2.25 0 0112.5 6h-6A2.25 2.25 0 014.25 4v-.5A.75.75 0 015 2z" clip-rule="evenodd" />
                                <path fill-rule="evenodd" d="M2 7a2 2 0 012-2h12a2 2 0 012 2v8a2 2 0 01-2 2H4a2 2 0 01-2-2V7zm3 4a.75.75 0 01.75-.75h.01a.75.75 0 01.75.75v.01a.75.75 0 01-.75.75h-.01a.75.75 0 01-.75-.75V11zm2.25-.75a.75.75 0 00-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 00.75-.75V11a.75.75 0 00-.75-.75h-.01zM11 11.75a.75.75 0 01.75-.75h.01a.75.75 0 01.75.75v.01a.75.75 0 01-.75.75h-.01a.75.75 0 01-.75-.75V11.75zM8.25 13a.75.75 0 01.75-.75h.01a.75.75 0 01.75.75v.01a.75.75 0 01-.75.75h-.01a.75.75 0 01-.75-.75V13zm3-1.75a.75.75 0 00-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 00.75-.75V12a.75.75 0 00-.75-.75h-.01zM6 13.75a.75.75 0 01.75-.75h.01a.75.75 0 01.75.75v.01a.75.75 0 01-.75.75h-.01a.75.75 0 01-.75-.75V13.75zM13.25 11a.75.75 0 00-.75.75v.01c0 .414.336.75.75.75h.01a.75.75 0 00.75-.75V11a.75.75 0 00-.75-.75h-.01zM14 13.75a.75.75 0 01.75-.75h.01a.75.75 0 01.75.75v.01a.75.75 0 01-.75.75h-.01a.75.75 0 01-.75-.75V13.75z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                    <input type="text" id="searchInput213" placeholder="Tìm kiếm theo Tên, Đơn vị công tác, SĐT, CCCD..." class="border-gray-300 rounded-md shadow-sm p-2 w-full col-span-1 md:col-span-4">
                    
                    <div class="relative col-span-1">
                        <button id="filterMenu213Btn" class="w-full py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-white text-gray-700 hover:bg-gray-50 border border-gray-300 flex items-center justify-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path fill-rule="evenodd" d="M2.628 1.601C5.028 1.206 7.49 1 10 1s4.973.206 7.372.601a.75.75 0 01.628.74v2.288a2.25 2.25 0 01-.659 1.59l-4.682 4.683a2.25 2.25 0 00-.659 1.59v3.037c0 .684-.31 1.33-.844 1.757l-1.937 1.55A.75.75 0 0110 18v-5.964a2.25 2.25 0 00-.659-1.59L4.659 5.77A2.25 2.25 0 014 4.18V2.34a.75.75 0 01.628-.74z" clip-rule="evenodd" />
                            </svg>
                            Sắp xếp & Lọc
                        </button>
                        
                        <div id="filterMenu213" class="absolute right-0 mt-2 w-72 bg-white border border-gray-200 rounded-lg shadow-xl z-10">
                             <div class="p-4 space-y-4">
                                <div>
                                    <h4 class="text-sm font-semibold text-gray-500 uppercase mb-2">Sắp xếp theo</h4>
                                    <div class="space-y-1">
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="sort213" value="partyAge_desc" class="form-radio text-purple-600" checked>
                                            <span class="text-sm">Tuổi Đảng (Cao ➔ Thấp)</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="sort213" value="partyAge_asc" class="form-radio text-purple-600">
                                            <span class="text-sm">Tuổi Đảng (Thấp ➔ Cao)</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="sort213" value="name_asc" class="form-radio text-purple-600">
                                            <span class="text-sm">Họ tên (A ➔ Z)</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="sort213" value="name_desc" class="form-radio text-purple-600">
                                            <span class="text-sm">Họ tên (Z ➔ A)</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <hr class="border-gray-200">
                                
                                <div>
                                    <h4 class="text-sm font-semibold text-gray-500 uppercase mb-2">Lọc theo Giới tính</h4>
                                    <div class="space-y-1">
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="gender213" value="all" class="form-radio text-purple-600" checked>
                                            <span class="text-sm">Tất cả</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="gender213" value="Nam" class="form-radio text-purple-600">
                                            <span class="text-sm">Nam</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="gender213" value="Nữ" class="form-radio text-purple-600">
                                            <span class="text-sm">Nữ</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <hr class="border-gray-200">
                                
                                <div>
                                    <h4 class="text-sm font-semibold text-gray-500 uppercase mb-2">Lọc theo Huy hiệu</h4>
                                    <div class="space-y-1">
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="medal213" value="all" class="form-radio text-purple-600" checked>
                                            <span class="text-sm">Tất cả</span>
                                        </label>
                                        <label class="flex items-center gap-2">
                                            <input type="radio" name="medal213" value="upcoming" class="form-radio text-purple-600">
                                            <span class="text-sm">Sắp nhận Huy hiệu</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <div class="overflow-x-auto border border-gray-200 rounded-lg shadow-sm">
                    <table class="min-w-full bg-white">
                        <thead class="bg-gray-800 text-white">
                            <tr>
                                <th class="py-3 px-4 border-b border-gray-600 w-12">
                                    <input type="checkbox" id="selectAll213Checkbox" title="Chọn tất cả" class="rounded border-gray-400 text-blue-500 focus:ring-blue-500">
                                </th>
                                <th class="py-3 px-4 border-b border-gray-600 text-center">ID</th>
                                <th class="py-3 px-4 border-b border-gray-600 text-left">Họ tên</th>
                                <th class="py-3 px-4 border-b border-gray-600 text-left">Đơn vị công tác</th>
                                <th class="py-3 px-4 border-b border-gray-600 text-center">Tuổi Đảng</th>
                                <th class="py-3 px-4 border-b border-gray-600 text-center">Hành động</th>
                            </tr>
                        </thead>
                        <tbody id="member213TableBody">
                            </tbody>
                    </table>
                </div>
                
                <div class="flex flex-col md:flex-row justify-between items-center gap-4 mt-6">
                    <div>
                        <select id="itemsPerPage213Select" class="border-gray-300 rounded-md shadow-sm p-2 text-sm">
                            <option value="10">Hiển thị 10/trang</option>
                            <option value="20">Hiển thị 20/trang</option>
                            <option value="50">Hiển thị 50/trang</option>
                            <option value="100">Hiển thị 100/trang</option>
                        </select>
                    </div>
                    <div id="pagination213Controls" class="flex justify-center items-center gap-1">
                    </div>
                </div>
            </div>
            </div>

        <footer class="text-center text-gray-500 text-sm mt-8 py-4">
            Hệ thống Quản lý Đảng viên (Local) &copy; 2025 - Phát triển bởi Phan Hoàng Anh
        </footer>
    </div>


    <div id="viewModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center p-4">
        <div class="relative mx-auto w-full max-w-2xl shadow-lg rounded-lg bg-white">
            <div class="p-6">
                <h3 class="text-2xl text-center leading-6 font-bold text-gray-900 mb-6" id="viewModalTitle">Chi tiết Đảng viên</h3>
                
                <div id="viewModalContent" class="mt-2 text-left space-y-6 max-h-[70vh] overflow-y-auto pr-2">
                    </div>

                <div class="items-center px-4 py-3 mt-6 gap-2 flex justify-end border-t border-gray-200 -mx-6 -mb-6 rounded-b-lg bg-gray-50">
                    <button id="printMemberBtn" type="button" class="py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500" onclick="printMemberDetails()">In Hồ sơ</button>
                    <button id="closeViewModalBtn" type="button" class="py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-gray-500 text-white hover:bg-gray-600 focus:ring-gray-400">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <div id="changePasswordModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center p-4 z-50">
        <div class="relative mx-auto w-full max-w-md shadow-lg rounded-lg bg-white">
            <form id="changePasswordForm" class="p-6">
                <h3 class="text-2xl text-center leading-6 font-bold text-gray-900 mb-6">Đổi Mật khẩu</h3>
                <div class="space-y-4">
                    <div>
                        <label for="oldPasswordInput" class="block text-sm font-medium text-gray-700">Mật khẩu cũ</label>
                        <input type="password" id="oldPasswordInput" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="newPasswordInput" class="block text-sm font-medium text-gray-700">Mật khẩu mới</label>
                        <input type="password" id="newPasswordInput" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                    <div>
                        <label for="confirmNewPasswordInput" class="block text-sm font-medium text-gray-700">Xác nhận mật khẩu mới</label>
                        <input type="password" id="confirmNewPasswordInput" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" required>
                    </div>
                </div>
                <div class="items-center px-4 py-3 mt-6 gap-2 flex justify-end border-t border-gray-200 -mx-6 -mb-6 rounded-b-lg bg-gray-50">
                    <button type="submit" id="confirmChangePasswordBtn" class="py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-yellow-500 text-white hover:bg-yellow-600 focus:ring-yellow-400">
                        Xác nhận Đổi
                    </button>
                    <button type="button" id="cancelChangePasswordBtn" class="py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-transparent text-gray-700 hover:bg-gray-100">
                        Hủy
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="memberModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center p-4">
        <div class="relative mx-auto w-full max-w-2xl shadow-lg rounded-lg bg-white">
            <form id="memberForm" class="p-6">
                <h3 class="text-xl leading-6 font-medium text-gray-900 mb-6" id="modalTitle">Thêm Đảng viên</h3>
                
                <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium">Họ tên <span class="text-red-600">*</span></label>
                            <input type="text" id="hoTen" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Ngày sinh <span class="text-red-600">*</span></label>
                            <input type="date" id="ngaySinh" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        <div id="donViCongTacGroup" class="col-span-1 md:col-span-2 hidden">
                            <label class="block text-sm font-medium">Đơn vị công tác <span class="text-red-600">*</span></label>
                            <input type="text" id="donViCongTac" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" placeholder="Tên cơ quan, đơn vị nơi sinh hoạt Đảng">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Giới tính <span class="text-red-600">*</span></label>
                            <select id="gioiTinh" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" required>
                                <option value="Nam">Nam</option>
                                <option value="Nữ">Nữ</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Quê quán <span class="text-red-600">*</span></label>
                            <input type="text" id="queQuan" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Số CCCD</label>
                            <input type="text" id="cccd" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Số điện thoại</label>
                            <input type="tel" id="soDienThoai" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div class="col-span-1 md:col-span-2">
                            <label class="block text-sm font-medium">Số thẻ Đảng viên</label>
                            <input type="text" id="soTheDang" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Ngày vào Đảng (Dự bị) <span class="text-red-600">*</span></label>
                            <input type="date" id="ngayVaoDang" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Ngày vào Đảng (Chính thức) <span class="text-red-600">*</span></label>
                            <input type="date" id="ngayChinhThuc" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" required>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium">Học vấn</label>
                            <input type="text" id="hocVan" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" placeholder="12/12, Cử nhân...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Lý luận Chính trị</label>
                            <input type="text" id="chinhTri" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" placeholder="Cao cấp, Trung cấp...">
                        </div>
                        <div class="col-span-1 md:col-span-2">
                            <label class="block text-sm font-medium">Chuyên môn</label>
                            <input type="text" id="chuyenMon" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" placeholder="Kỹ sư CNTT, Kế toán...">
                        </div>

                        <div>
                            <label class="block text-sm font-medium">Chức vụ</label>
                            <input type="text" id="chucVu" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2" placeholder="Bí thư, P.Bí thư, Đảng viên...">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Trạng thái</label>
                            <select id="trangThai" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2">
                                <option value="Đang sinh hoạt">Đang sinh hoạt</option>
                                <option value="Miễn sinh hoạt">Miễn sinh hoạt</option>
                                <option value="Chuyển đi">Chuyển đi</option>
                                <option value="Đã qua đời">Đã qua đời</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="medalCheckboxesGroup" class="pt-2">
                        <label class="block text-sm font-medium col-span-2">Huy hiệu Đảng đã nhận:</label>
                        <div id="receivedMedalCheckboxes" class="grid grid-cols-4 md:grid-cols-6 gap-3 mt-2 border border-gray-200 p-3 rounded-md">
                            </div>
                    </div>
                    
                    <div class="pt-2">
                        <label class="block text-sm font-medium">Ghi chú</label>
                        <textarea id="ghiChu" rows="2" class="mt-1 w-full border-gray-300 rounded-md shadow-sm p-2"></textarea>
                    </div>
                </div>

                <div class="items-center px-4 py-3 mt-6 gap-2 flex justify-end border-t border-gray-200 -mx-6 -mb-6 rounded-b-lg bg-gray-50">
                    <input type="hidden" id="memberId">
                    <input type="hidden" id="currentTab" value="main"> <button id="saveBtn" type="submit" class="py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-green-600 text-white hover:bg-green-700 focus:ring-green-500">Lưu</button>
                    <button id="cancelBtn" type="button" class="py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-transparent text-gray-700 hover:bg-gray-100">Hủy</button>
                </div>
            </form>
        </div>
    </div>
    
    
    <div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center p-4">
        <div class="relative mx-auto w-full max-w-md shadow-lg rounded-lg bg-white">
            <div class="p-6">
                <div class="flex items-start">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                        <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                    </div>
                    <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                        <h3 class="text-lg leading-6 font-medium text-gray-900" id="deleteModalTitle">Xác nhận xóa</h3>
                        <div class="mt-2">
                            <p class="text-sm text-gray-500" id="deleteModalBody">Bạn có chắc chắn muốn xóa mục này? Hành động này không thể hoàn tác.</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="items-center px-4 py-3 gap-3 flex justify-end rounded-b-lg bg-gray-50">
                <button id="confirmDeleteBtn" type="button" class="py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-red-600 text-white hover:bg-red-700 focus:ring-red-500">Xác nhận Xóa</button>
                <button id="cancelDeleteBtn" type="button" class="py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-transparent text-gray-700 hover:bg-gray-100">Hủy</button>
            </div>
        </div>
    </div>
    
    <div id="helpModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center p-4">
        <div class="relative mx-auto w-full max-w-3xl shadow-lg rounded-lg bg-white">
            <div class="p-6">
                <h3 class="text-2xl text-center leading-6 font-bold text-gray-900 mb-6">📖 Hướng dẫn sử dụng</h3>
                
                <div id="helpModalContent" class="mt-2 text-left space-y-6 max-h-[70vh] overflow-y-auto pr-3 text-gray-700">
                    
                    <div>
                        <h4 class="text-lg font-bold text-gray-900 mb-2">1. 🔐 Đăng nhập và Bảo mật</h4>
                        <div class="pl-4 space-y-3">
                            <div class="bg-red-100 p-3 rounded-md border border-red-300 text-red-800 text-sm">
                                <strong class="font-semibold">QUAN TRỌNG: KHÔNG BAO GIỜ QUÊN MẬT KHẨU!</strong>
                                <br>Dữ liệu của bạn được mã hoá bằng mật khẩu này. Nếu bạn quên, dữ liệu sẽ bị mất vĩnh viễn và không thể khôi phục.
                            </div>
                            <ul class="list-disc list-inside ml-4 space-y-1">
                                <li><strong>Lần đầu sử dụng:</strong> Mật khẩu bạn nhập tại màn hình "Đã khoá" sẽ trở thành mật khẩu chủ để mã hoá dữ liệu.</li>
                                <li><strong>Những lần sau:</strong> Dùng đúng mật khẩu đó để mở khoá và giải mã dữ liệu.</li>
                            </ul>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-bold text-gray-900 mb-2">2. ✨ Chức năng Cơ bản (Hàng ngày)</h4>
                        <div class="pl-4 space-y-3">
                            <div>
                                <h5 class="font-semibold text-gray-800">a. Thêm Đảng viên mới</h5>
                                <ol class="list-decimal list-inside ml-4 space-y-1">
                                    <li>Nhấn nút màu xanh <strong class="text-blue-600">"+ Thêm Đảng viên"</strong>.</li>
                                    <li>Một cửa sổ (modal) sẽ hiện lên.</li>
                                    <li>Điền các thông tin (SĐT, Học vấn, Chính trị, Chuyên môn...).</li>
                                    <li>Tại mục "Huy hiệu Đảng đã nhận", hãy tích chọn vào các mốc mà Đảng viên đó <em>đã</em> được trao. (Chỉ áp dụng cho Đảng viên Chính thức)</li>
                                    <li>Nhấn <strong>"Lưu"</strong>. Hệ thống sẽ tự động kiểm tra lỗi (ví dụ: Ngày chính thức trước ngày dự bị) trước khi lưu.</li>
                                </ol>
                            </div>
                            <div>
                                <h5 class="font-semibold text-gray-800">b. Xem Thông tin Chi tiết</h5>
                                <ol class="list-decimal list-inside ml-4 space-y-1">
                                    <li>Tại hàng của Đảng viên, nhấn nút <strong>"Xem"</strong> (màu xanh lá).</li>
                                    <li>Modal chi tiết sẽ hiện ra, hiển thị <em>toàn bộ</em> thông tin, bao gồm cả "Tuổi đời" và "Tuổi Đảng" (tính từ ngày dự bị).</li>
                                    <li>Tại mục "Tính tuổi Đảng (các mốc)", bạn có thể chọn một năm bất kỳ để xem tuổi Đảng tại 4 mốc lễ (03/02, 19/5, 02/09, 07/11).</li>
                                    <li>Nhấn nút <strong>"In Hồ sơ"</strong> (màu xanh dương) để tạo một trang A4 Sơ yếu lý lịch chuẩn để in ấn.</li>
                                </ol>
                            </div>
                            <div>
                                <h5 class="font-semibold text-gray-800">c. Sửa thông tin Đảng viên</h5>
                                <ol class="list-decimal list-inside ml-4 space-y-1">
                                    <li>Nhấn nút <strong>"Sửa"</strong> (màu xanh dương) tại hàng của Đảng viên.</li>
                                    <li>Khi một Đảng viên vừa nhận Huy hiệu mới (chỉ tab Chính thức), bạn phải vào đây và **tích chọn thêm vào ô huy hiệu đó**.</li>
                                    <li>Nhấn <strong>"Lưu"</strong> để cập nhật.</li>
                                </ol>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-bold text-gray-900 mb-2">3. 🔍 Tìm kiếm, Sắp xếp & Lọc</h4>
                        <div class="pl-4 space-y-3">
                            <p><strong>Ô Tìm kiếm:</strong> Gõ bất cứ gì (Họ tên, Quê quán, SĐT, CCCD,...) để tìm kiếm. Danh sách sẽ tự động lọc lại.</p>
                            <div>
                                <h5 class="font-semibold text-gray-800">Nút "Sắp xếp & Lọc" (hình cái phễu)</h5>
                                <p>Nhấn vào nút này để mở menu tùy chọn:</p>
                                <ul class="list-disc list-inside ml-4 space-y-1">
                                    <li>**Sắp xếp theo:** Xếp danh sách theo Tuổi Đảng (Cao-Thấp hoặc Thấp-Cao) và Họ tên (A-Z hoặc Z-A).</li>
                                    <li>**Lọc theo Giới tính:** Chỉ xem Nam, Nữ, hoặc Tất cả.</li>
                                    <li>**Lọc theo Huy hiệu:** Lọc nhanh danh sách "Sắp nhận Huy hiệu".</li>
                                </ul>
                            </div>
                            <p><strong>Hiển thị .../trang:</strong> Nằm ở góc dưới bên trái của bảng, cho phép bạn chọn xem 10, 20, 50, hoặc 100 mục trên một trang.</p>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-bold text-gray-900 mb-2">4. ⚠️ Sao lưu và Phục hồi (MÃ HOÁ)</h4>
                        <div class="pl-4 space-y-3">
                            <div class="bg-yellow-100 p-3 rounded-md border border-yellow-300 text-yellow-800 text-sm">
                                <strong class="font-semibold">Cảnh báo:</strong> Dữ liệu được mã hoá bằng mật khẩu của bạn. Nếu quên mật khẩu, file sao lưu cũng sẽ VÔ DỤNG.
                            </div>
                            
                            <div>
                                <h5 class="font-semibold text-gray-800">a. Cách Sao lưu (Nên làm hàng tuần)</h5>
                                <ol class="list-decimal list-inside ml-4 space-y-1">
                                    <li>Nhấn nút **"Xuất JSON"** (màu xanh lá).</li>
                                    <li>Một tệp <code>...encrypted.json.txt</code> sẽ được tải về. Đây là file đã được mã hoá.</li>
                                    <li>Hãy cất tệp này vào nơi an toàn (USB, Google Drive...).</li>
                                </ol>
                            </div>
                            <div>
                                <h5 class="font-semibold text-gray-800">b. Cách Phục hồi (Khi mất dữ liệu)</h5>
                                <ol class="list-decimal list-inside ml-4 space-y-1">
                                    <li>Mở tệp <code>quanlydangvien.html</code> và đăng nhập bằng mật khẩu của bạn.</li>
                                    <li>Nhấn vào nút **"Nhập JSON (Restore)"** (màu vàng).</li>
                                    <li>Chọn tệp <code>...encrypted.json.txt</code> (hoặc file <code>.json</code> cũ không mã hoá) mà bạn đã sao lưu.</li>
                                    <li>Hệ thống sẽ dùng mật khẩu bạn đang đăng nhập để giải mã và khôi phục.</li>
                                </ol>
                            </div>
                            <div>
                                <h5 class="font-semibold text-gray-800">c. Nhập/Xuất CSV</h5>
                                <ul class="list-disc list-inside ml-4 space-y-1">
                                    <li>Sử dụng các nút màu Xám và Xanh lam/xanh ngọc để thao tác với file CSV.</li>
                                    <li>Lưu ý: Xuất/Nhập CSV **không mã hóa** và cần tuân thủ cấu trúc header.</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="items-center px-4 py-3 mt-6 gap-2 flex justify-end border-t border-gray-200 -mx-6 -mb-6 rounded-b-lg bg-gray-50">
                    <button id="closeHelpModalBtn" type="button" class="py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-gray-500 text-white hover:bg-gray-600 focus:ring-gray-400">Đã hiểu</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="statsModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full items-center justify-center p-4">
        <div class="relative mx-auto w-full max-w-2xl shadow-lg rounded-lg bg-white">
            <div class="p-6">
                <div id="statsModalContent" class="mt-2 text-left space-y-6 max-h-[70vh] overflow-y-auto pr-3 text-gray-700">
                    </div>

                <div class="items-center px-4 py-3 mt-6 gap-2 flex justify-end border-t border-gray-200 -mx-6 -mb-6 rounded-b-lg bg-gray-50">
                    <button id="closeStatsModalBtn" type="button" class="py-2 px-4 rounded-md font-semibold shadow-sm transition-all duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 bg-gray-500 text-white hover:bg-gray-600 focus:ring-gray-400">Đóng</button>
                </div>
            </div>
        </div>
    </div>


    <script>
        
        // =================================================================================
        // --- 1. BIẾN GLOBAL VÀ HÀM TIỆN ÍCH CƠ BẢN ---
        // =================================================================================
        const ALL_MILESTONES = [30, 40, 45, 50, 55, 60, 65, 70, 75, 80, 85, 90];
        let members = [];
        let members213 = []; 
        let appKey = null; 
        let currentTab = 'main'; 
        let currentPage = 1;
        let totalPages = 1;
        let itemsPerPage = 10;
        let currentSort = 'partyAge_desc';
        let currentGenderFilter = 'all';
        let currentMedalFilter = 'all';
        let itemToDelete = null;
        let memberToPrint = null; 

        function getTuoiDang(ngayVaoDang) {
            return calculateAgeAtDate(ngayVaoDang, new Date());
        }
        function calculateAgeAtDate(startDateString, endDate) {
            if (!startDateString) return 0;
            const birthDate = new Date(startDateString);
            let age = endDate.getFullYear() - birthDate.getFullYear();
            const m = endDate.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && endDate.getDate() < birthDate.getDate())) {
                age--;
            }
            return age;
        }
        function getTuoiDoi(ngaySinh) {
            return calculateAgeAtDate(ngaySinh, new Date());
        }
        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const [y, m, d] = dateString.split('-');
                if (y && m && d) {
                    return `${d}/${m}/${y}`;
                }
                return dateString;
            } catch (e) {
                return dateString;
            }
        }
        function getTrangThaiClass(trangThai) {
            switch (trangThai) {
                case 'Đang sinh hoạt': return 'bg-green-100 text-green-800';
                case 'Miễn sinh hoạt': return 'bg-yellow-100 text-yellow-800';
                case 'Chuyển đi': return 'bg-blue-100 text-blue-800';
                case 'Đã qua đời': return 'bg-gray-100 text-gray-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // --- HÀM IN ẤN (ĐƯA RA PHẠM VI GLOBAL ĐỂ NÚT onclick="printMemberDetails()" HOẠT ĐỘNG) ---
        function printMemberDetails() {
            if (memberToPrint === null) return;
            
            const { member, is213 } = memberToPrint;
            const tuoiDoi = getTuoiDoi(member.ngaySinh);
            const partyAge = getTuoiDang(member.ngayVaoDang);
            const received = member.receivedMedals || [];
            const receivedText = received.length > 0 ? received.join(', ') + ' năm' : 'Chưa nhận';
            
            let donViCongTacRow = '';
            if (is213) {
                donViCongTacRow = `
                    <tr>
                        <td>Đơn vị công tác (Nơi SH Đảng):</td>
                        <td>${member.donViCongTac || 'Chưa cập nhật'}</td>
                    </tr>
                `;
            }

            const printContent = `
                <html>
                    <head>
                        <title>Hồ sơ Đảng viên ${is213 ? '(213)' : ''}: ${member.hoTen}</title>
                        <style>
                            body { font-family: 'Times New Roman', Times, serif; margin: 2cm; font-size: 13pt; line-height: 1.5; }
                            .photo-placeholder { float: left; width: 4cm; height: 6cm; border: 2px solid #000; display: flex; align-items: center; justify-content: center; color: #aaa; font-size: 11pt; font-style: italic; box-sizing: border-box; }
                            .header-content { margin-left: 5cm; padding-top: 1cm; text-align: center; }
                            .header-content h1 { font-size: 16pt; font-weight: bold; text-transform: uppercase; margin: 5px 0; }
                            .header-content h3 { font-size: 14pt; font-weight: normal; margin: 0; }
                            .header-content h4 { font-size: 13pt; font-weight: bold; margin: 0; }
                            .clear-float { clear: both; }
                            h2 { font-size: 14pt; font-weight: bold; border-bottom: 1px solid #000; padding-bottom: 5px; margin-top: 20px; margin-bottom: 15px; }
                            table { width: 100%; border-collapse: collapse; }
                            td { padding: 8px 0; vertical-align: top; border-bottom: 1px dashed #ccc; }
                            td:first-child { font-weight: bold; width: 35%; }
                            table tr:last-child td { border-bottom: none; }
                        </style>
                    </head>
                    <body>
                        <div class="photo-placeholder">Ảnh 4x6</div>
                        <div class="header-content">
                            <h3>ĐẢNG ỦY PHƯỜNG LONG XUYÊN</h3>
                            <h4>CHI BỘ KHÓM ĐÔNG AN</h4>
                            <h1>Hồ sơ Đảng viên ${is213 ? '213 (Cư trú)' : 'Chính thức'}</h1>
                        </div>
                        <div class="clear-float"></div>

                        <h2>I. Thông tin cá nhân</h2>
                        <table>
                            <tr><td>Họ và tên:</td><td>${member.hoTen}</td></tr>
                            <tr><td>Ngày sinh (Tuổi đời):</td><td>${formatDate(member.ngaySinh)} (${tuoiDoi} tuổi)</td></tr>
                            <tr><td>Giới tính:</td><td>${member.gioiTinh}</td></tr>
                            <tr><td>Quê quán:</td><td>${member.queQuan || 'Chưa cập nhật'}</td></tr>
                            ${donViCongTacRow} 
                            <tr><td>Số CCCD:</td><td>${member.cccd || 'Chưa cập nhật'}</td></tr>
                            <tr><td>Số điện thoại:</td><td>${member.soDienThoai || 'Chưa cập nhật'}</td></tr>
                        </table>

                        <h2>II. Trình độ</h2>
                        <table>
                            <tr><td>Học vấn:</td><td>${member.hocVan || 'Chưa cập nhật'}</td></tr>
                            <tr><td>Lý luận Chính trị:</td><td>${member.chinhTri || 'Chưa cập nhật'}</td></tr>
                            <tr><td>Chuyên môn:</td><td>${member.chuyenMon || 'Chưa cập nhật'}</td></tr>
                        </table>

                        <h2>III. Thông tin Đảng</h2>
                        <table>
                            <tr><td>Số thẻ Đảng viên:</td><td>${member.soTheDang || 'Chưa cập nhật'}</td></tr>
                            <tr><td>Ngày vào Đảng (Dự bị):</td><td>${formatDate(member.ngayVaoDang)}</td></tr>
                            <tr><td>Ngày vào Đảng (Chính thức):</td><td>${formatDate(member.ngayChinhThuc)}</td></tr>
                            <tr><td>Tuổi Đảng (hiện tại):</td><td>${partyAge} năm (Tính từ ngày dự bị)</td></tr>
                            <tr><td>Huy hiệu đã nhận:</td><td>${receivedText}</td></tr>
                            <tr><td>Chức vụ:</td><td>${member.chucVu || 'Đảng viên'}</td></tr>
                            <tr><td>Trạng thái:</td><td>${member.trangThai}</td></tr>
                            <tr><td>Ghi chú:</td><td>${member.ghiChu || 'Không có'}</td></tr>
                        </table>

                    </body>
                </html>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.open();
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus(); 
            printWindow.print();
            printWindow.close();
        }

        document.addEventListener('DOMContentLoaded', () => {
            
            // =================================================================================
            // --- 2. KHAI BÁO DOM ---
            // =================================================================================
            const memberModal = document.getElementById('memberModal'); 
            const memberForm = document.getElementById('memberForm');
            const cancelBtn = document.getElementById('cancelBtn');
            const modalTitle = document.getElementById('modalTitle');
            const receivedMedalCheckboxes = document.getElementById('receivedMedalCheckboxes');
            const viewModal = document.getElementById('viewModal');
            const viewModalTitle = document.getElementById('viewModalTitle');
            const viewModalContent = document.getElementById('viewModalContent');
            const printMemberBtn = document.getElementById('printMemberBtn');
            const deleteModal = document.getElementById('deleteModal');
            const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
            const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
            const statsModal = document.getElementById('statsModal');
            const statsModalContent = document.getElementById('statsModalContent');
            const donViCongTacGroup = document.getElementById('donViCongTacGroup'); 
            const currentTabInput = document.getElementById('currentTab'); 
            const medalCheckboxesGroup = document.getElementById('medalCheckboxesGroup');
            const deleteModalTitle = document.getElementById('deleteModalTitle');
            const deleteModalBody = document.getElementById('deleteModalBody');
            const helpModal = document.getElementById('helpModal');
            const closeHelpModalBtn = document.getElementById('closeHelpModalBtn');
            const authModal = document.getElementById('authModal');
            const appContainer = document.getElementById('appContainer');
            const passwordInput = document.getElementById('passwordInput');
            const loginBtn = document.getElementById('loginBtn');
            const mainMemberContainer = document.getElementById('mainMemberContainer');
            const memberTableBody = document.getElementById('memberTableBody');
            const addMemberBtn = document.getElementById('addMemberBtn');
            const searchInput = document.getElementById('searchInput');
            const filterMenuBtn = document.getElementById('filterMenuBtn');
            const filterMenu = document.getElementById('filterMenu');
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const paginationControls = document.getElementById('paginationControls');
            const itemsPerPageSelect = document.getElementById('itemsPerPageSelect');
            const statTotal = document.getElementById('statTotal');
            const statMale = document.getElementById('statMale');
            const statFemale = document.getElementById('statFemale');
            const statMedal = document.getElementById('statMedal');
            const exportBtn = document.getElementById('exportBtn');
            const importInput = document.getElementById('importInput');
            const downloadCsvTemplateBtn = document.getElementById('downloadCsvTemplateBtn');
            const importCsvInput = document.getElementById('importCsvInput');
            const exportCsvBtn = document.getElementById('exportCsvBtn');
            const statsBtn = document.getElementById('statsBtn');
            const member213Container = document.getElementById('member213Container');
            const member213TableBody = document.getElementById('member213TableBody');
            const addMember213Btn = document.getElementById('addMember213Btn');
            const searchInput213 = document.getElementById('searchInput213');
            const filterMenu213Btn = document.getElementById('filterMenu213Btn');
            const filterMenu213 = document.getElementById('filterMenu213');
            const bulkDelete213Btn = document.getElementById('bulkDelete213Btn');
            const selectAll213Checkbox = document.getElementById('selectAll213Checkbox');
            const pagination213Controls = document.getElementById('pagination213Controls');
            const itemsPerPage213Select = document.getElementById('itemsPerPage213Select');
            const stat213Total = document.getElementById('stat213Total');
            const stat213Male = document.getElementById('stat213Male');
            const stat213Female = document.getElementById('stat213Female');
            const stat213Medal = document.getElementById('stat213Medal');
            const export213Btn = document.getElementById('export213Btn');
            const import213Input = document.getElementById('import213Input');
            const downloadCsvTemplate213Btn = document.getElementById('downloadCsvTemplate213Btn');
            const importCsv213Input = document.getElementById('importCsv213Input');
            const exportCsv213Btn = document.getElementById('exportCsv213Btn');
            const stats213Btn = document.getElementById('stats213Btn');

            // --- DOM ĐỔI MẬT KHẨU MỚI ---
            const changePasswordBtn = document.getElementById('changePasswordBtn');
            const changePasswordModal = document.getElementById('changePasswordModal');
            const changePasswordForm = document.getElementById('changePasswordForm');
            const cancelChangePasswordBtn = document.getElementById('cancelChangePasswordBtn');


            // =================================================================================
            // --- 3. HÀM XỬ LÝ DỮ LIỆU & LƯU TRỮ (CORE LOGIC) ---
            // =================================================================================
            
            function getCurrentData() { return currentTab === 'main' ? members : members213; }
            
            function loadSpecificData(encryptedKey, oldKey) {
                const encryptedData = localStorage.getItem(encryptedKey);
                const oldData = localStorage.getItem(oldKey);

                if (!encryptedData && oldData) {
                    try {
                        const data = JSON.parse(oldData);
                        if (Array.isArray(data)) {
                            const dataString = JSON.stringify(data);
                            const encrypted = CryptoJS.AES.encrypt(dataString, appKey).toString();
                            localStorage.setItem(encryptedKey, encrypted);
                            localStorage.removeItem(oldKey);
                            return data;
                        }
                    } catch (e) {}
                }
                if (!encryptedData) { return []; }
                
                try {
                    const decryptedBytes = CryptoJS.AES.decrypt(encryptedData, appKey);
                    const decryptedData = decryptedBytes.toString(CryptoJS.enc.Utf8);
                    if (!decryptedData) throw new Error("Giải mã ra chuỗi rỗng.");
                    const data = JSON.parse(decryptedData);
                    if (!Array.isArray(data)) throw new Error("Dữ liệu bị lỗi");
                    return data; 
                } catch (e) {
                    throw e;
                }
            }
            
            function loadFromLocalStorage() {
                if (!appKey) { return false; }
                
                try {
                    members = loadSpecificData('partyMembers_encrypted', 'partyMembers');
                } catch (e) {
                    members = [];
                    throw e;
                }
                try {
                    members213 = loadSpecificData('partyMembers213_encrypted', 'partyMembers213');
                } catch (e) {
                    members213 = [];
                }
                return true;
            }

            function saveSpecificData(data, key) {
                try {
                    const dataString = JSON.stringify(data);
                    const encryptedData = CryptoJS.AES.encrypt(dataString, appKey).toString();
                    localStorage.setItem(key, encryptedData);
                } catch (e) {
                    console.error(`Lỗi mã hoá key ${key}:`, e);
                    alert("Đã xảy ra lỗi nghiêm trọng khi mã hoá dữ liệu! Vui lòng sao lưu JSON ngay lập tức.");
                }
            }
            
            function saveToLocalStorage() {
                if (!appKey) { return; }
                // Lưu lại cả hai mảng dữ liệu (đã được mã hoá bằng appKey hiện tại)
                saveSpecificData(members, 'partyMembers_encrypted');
                saveSpecificData(members213, 'partyMembers213_encrypted');
            }

            // =================================================================================
            // --- 4. HÀM XỬ LÝ ĐỔI MẬT KHẨU (MỚI) ---
            // =================================================================================

            function openChangePasswordModal() {
                changePasswordForm.reset();
                if (changePasswordModal) changePasswordModal.classList.add('show');
                const oldPassInput = document.getElementById('oldPasswordInput');
                if (oldPassInput) oldPassInput.focus();
            }

            function closeChangePasswordModal() {
                if (changePasswordModal) changePasswordModal.classList.remove('show');
                if (changePasswordForm) changePasswordForm.reset();
            }

            function handleChangePasswordSubmit(event) {
                event.preventDefault();

                const oldPass = document.getElementById('oldPasswordInput').value;
                const newPass = document.getElementById('newPasswordInput').value;
                const confirmNewPass = document.getElementById('confirmNewPasswordInput').value;

                if (newPass !== confirmNewPass) {
                    alert("Lỗi: Mật khẩu mới và Xác nhận mật khẩu mới không khớp.");
                    return;
                }
                if (newPass.length < 1) {
                     alert("Lỗi: Mật khẩu mới không được để trống.");
                    return;
                }
                if (oldPass !== appKey) {
                    alert("Lỗi: Mật khẩu cũ không chính xác.");
                    return;
                }
                
                // --- CRITICAL SECURITY STEP: RE-ENCRYPT DATA ---
                const oldAppKey = appKey;
                appKey = newPass;

                try {
                    // Re-encrypt both datasets and save using the new appKey
                    saveToLocalStorage(); 
                    
                    alert("Đổi mật khẩu thành công! Dữ liệu của bạn đã được mã hoá lại.");
                    closeChangePasswordModal();

                } catch (e) {
                    console.error("Lỗi đổi mật khẩu:", e);
                    // Revert key if re-encryption/saving fails
                    appKey = oldAppKey;
                    alert("Lỗi nghiêm trọng khi đổi mật khẩu và mã hoá lại dữ liệu. Mật khẩu vẫn là mật khẩu cũ.");
                }
            }


            // =================================================================================
            // --- 5. CÁC HÀM XỬ LÝ CHUNG VÀ RENDER ---
            // =================================================================================

            function getUpcomingMedal(ngayVaoDang, receivedMedals = []) {
                if (!ngayVaoDang) return '';
                const received = receivedMedals || [];
                let nextMilestone = null;

                for (const m of ALL_MILESTONES) {
                    if (!received.includes(m)) {
                        nextMilestone = m; 
                        break;
                    }
                }

                if (nextMilestone === null) {
                    if (ALL_MILESTONES.length > 0) return `Đã nhận ${ALL_MILESTONES[ALL_MILESTONES.length - 1]} năm`;
                    return 'N/A';
                }

                const officialDate = new Date(ngayVaoDang);
                const milestoneDate = new Date(officialDate.getFullYear() + nextMilestone, officialDate.getMonth(), officialDate.getDate());
                
                const today = new Date();
                const oneYearFromNow = new Date();
                oneYearFromNow.setFullYear(today.getFullYear() + 1);

                if (milestoneDate > today && milestoneDate <= oneYearFromNow) {
                    return `Sắp nhận ${nextMilestone} năm`;
                }
                return ''; 
            }
            
            function renderTable(dataToRender) {
                const tbody = currentTab === 'main' ? memberTableBody : member213TableBody;
                if (!tbody) return;
                
                tbody.innerHTML = '';
                const isMain = currentTab === 'main';
                const colspan = isMain ? 7 : 6;
                
                if (dataToRender.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center p-6 text-gray-500">Không tìm thấy dữ liệu</td></tr>`;
                    return;
                }
                
                dataToRender.forEach(member => {
                    const partyAge = getTuoiDang(member.ngayVaoDang);
                    const upcomingMedal = getUpcomingMedal(member.ngayVaoDang, member.receivedMedals) || '';
                    
                    const rowHtml = isMain ? `
                        <tr class="hover:bg-gray-50">
                            <td class="py-3 px-4 border-b border-gray-200 text-center">
                                <input type="checkbox" class="member-checkbox rounded border-gray-300 text-blue-500 focus:ring-blue-500" data-id="${member.id}" data-tab="${currentTab}">
                            </td>
                            <td class="py-3 px-4 border-b border-gray-200 text-center text-sm text-gray-600">${member.id}</td>
                            <td class="py-3 px-4 border-b border-gray-200 font-medium text-gray-900">${member.hoTen}</td>
                            <td class="py-3 px-4 border-b border-gray-200 text-center font-bold text-gray-800">${partyAge}</td>
                            <td class="py-3 px-4 border-b border-gray-200 text-center text-red-600 font-medium">${upcomingMedal}</td>
                            <td class="py-3 px-4 border-b border-gray-200 text-center text-sm">
                                <span class="px-2 py-1 font-semibold leading-tight text-xs rounded-full ${getTrangThaiClass(member.trangThai)}">
                                    ${member.trangThai || '...'}
                                </span>
                            </td>
                            <td class="py-3 px-4 border-b border-gray-200 text-center whitespace-nowrap">
                                <button class="view-btn text-green-600 hover:text-green-800 font-medium py-1 px-2 rounded hover:bg-green-100" data-id="${member.id}" data-tab="${currentTab}">Xem</button>
                                <button class="edit-btn text-blue-600 hover:text-blue-800 font-medium py-1 px-2 rounded ml-1 hover:bg-blue-100" data-id="${member.id}" data-tab="${currentTab}">Sửa</button>
                                <button class="delete-btn text-red-600 hover:text-red-800 font-medium py-1 px-2 rounded ml-1 hover:bg-red-100" data-id="${member.id}" data-tab="${currentTab}">Xóa</button>
                            </td>
                        </tr>
                    ` : `
                        <tr class="hover:bg-gray-50">
                            <td class="py-3 px-4 border-b border-gray-200 text-center">
                                <input type="checkbox" class="member-checkbox rounded border-gray-300 text-purple-500 focus:ring-purple-500" data-id="${member.id}" data-tab="${currentTab}">
                            </td>
                            <td class="py-3 px-4 border-b border-gray-200 text-center text-sm text-gray-600">${member.id}</td>
                            <td class="py-3 px-4 border-b border-gray-200 font-medium text-gray-900">${member.hoTen}</td>
                            <td class="py-3 px-4 border-b border-gray-200 text-left text-sm text-purple-700">${member.donViCongTac || 'N/A'}</td>
                            <td class="py-3 px-4 border-b border-gray-200 text-center font-bold text-gray-800">${partyAge}</td>
                            <td class="py-3 px-4 border-b border-gray-200 text-center whitespace-nowrap">
                                <button class="view-btn text-green-600 hover:text-green-800 font-medium py-1 px-2 rounded hover:bg-green-100" data-id="${member.id}" data-tab="${currentTab}">Xem</button>
                                <button class="edit-btn text-blue-600 hover:text-blue-800 font-medium py-1 px-2 rounded ml-1 hover:bg-blue-100" data-id="${member.id}" data-tab="${currentTab}">Sửa</button>
                                <button class="delete-btn text-red-600 hover:text-red-800 font-medium py-1 px-2 rounded ml-1 hover:bg-red-100" data-id="${member.id}" data-tab="${currentTab}">Xóa</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += rowHtml;
                });
            }

            function updateDashboard(data) {
                const total = data.length;
                const male = data.filter(m => m.gioiTinh === 'Nam').length;
                const female = data.filter(m => m.gioiTinh === 'Nữ').length;
                const medal = data.filter(m => getUpcomingMedal(m.ngayVaoDang, m.receivedMedals).startsWith('Sắp nhận')).length;
                
                if (currentTab === 'main') {
                    if(statTotal) statTotal.textContent = total;
                    if(statMale) statMale.textContent = male;
                    if(statFemale) statFemale.textContent = female;
                    if(statMedal) statMedal.textContent = medal;
                } else {
                    if(stat213Total) stat213Total.textContent = total;
                    if(stat213Male) stat213Male.textContent = male;
                    if(stat213Female) stat213Female.textContent = female;
                    if(stat213Medal) stat213Medal.textContent = medal;
                }
            }

            function applyFiltersAndRender() {
                const isMain = currentTab === 'main';
                
                const searchInputDom = isMain ? searchInput : searchInput213;
                const itemsPerPageDom = isMain ? itemsPerPageSelect : itemsPerPage213Select;
                if(itemsPerPageDom) itemsPerPage = parseInt(itemsPerPageDom.value);
                
                const searchTerm = searchInputDom ? searchInputDom.value.toLowerCase() : '';
                const gender = currentGenderFilter;
                const medalFilter = currentMedalFilter;
                
                let filteredMembers = getCurrentData();
                
                if (searchTerm) {
                    filteredMembers = filteredMembers.filter(m => 
                        m.hoTen.toLowerCase().includes(searchTerm) ||
                        (m.queQuan && m.queQuan.toLowerCase().includes(searchTerm)) ||
                        (m.cccd && m.cccd.includes(searchTerm)) ||
                        (m.soDienThoai && m.soDienThoai.includes(searchTerm)) || 
                        (m.soTheDang && m.soTheDang.includes(searchTerm)) ||
                        (!isMain && m.donViCongTac && m.donViCongTac.toLowerCase().includes(searchTerm))
                    );
                }
                
                if (gender !== 'all') { filteredMembers = filteredMembers.filter(m => m.gioiTinh === gender); }
                if (medalFilter === 'upcoming') {
                    filteredMembers = filteredMembers.filter(m => getUpcomingMedal(m.ngayVaoDang, m.receivedMedals).startsWith('Sắp nhận'));
                }
                
                switch (currentSort) {
                    case 'partyAge_desc': filteredMembers.sort((a, b) => getTuoiDang(b.ngayVaoDang) - getTuoiDang(a.ngayVaoDang)); break;
                    case 'partyAge_asc': filteredMembers.sort((a, b) => getTuoiDang(a.ngayVaoDang) - getTuoiDang(b.ngayVaoDang)); break;
                    case 'name_asc': filteredMembers.sort((a, b) => a.hoTen.localeCompare(b.hoTen, 'vi')); break;
                    case 'name_desc': filteredMembers.sort((a, b) => b.hoTen.localeCompare(a.hoTen, 'vi')); break;
                }

                updateDashboard(filteredMembers);

                const totalItems = filteredMembers.length;
                totalPages = Math.ceil(totalItems / itemsPerPage);
                if (totalPages === 0) totalPages = 1;
                if (currentPage > totalPages) { currentPage = 1; }
                
                const startIndex = (currentPage - 1) * itemsPerPage;
                const endIndex = startIndex + itemsPerPage;
                const paginatedItems = filteredMembers.slice(startIndex, endIndex);
                
                renderTable(paginatedItems); 
                renderPagination(); 
                updateBulkDeleteButtonState();
            }

            function renderPagination() {
                const controls = currentTab === 'main' ? paginationControls : pagination213Controls;
                if (!controls) return;
                
                controls.innerHTML = ''; 
                
                const baseButtonClass = "py-1.5 px-3 rounded-md border text-sm";
                const activeText = "bg-blue-600 text-white border-blue-600";
                const defaultText = "bg-white text-gray-700 hover:bg-gray-50 border-gray-300";
                const disabledText = "text-gray-300 cursor-not-allowed bg-gray-50 border-gray-200";

                const prevButton = document.createElement('button');
                prevButton.textContent = 'Trước';
                prevButton.dataset.page = 'prev';
                prevButton.className = `${baseButtonClass} ${defaultText}`;
                if (currentPage === 1) {
                    prevButton.disabled = true;
                    prevButton.className = `${baseButtonClass} ${disabledText}`;
                }
                controls.appendChild(prevButton);

                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(totalPages, currentPage + 2);
                if (currentPage <= 3) { endPage = Math.min(5, totalPages); }
                if (currentPage > totalPages - 3) { startPage = Math.max(1, totalPages - 4); }
                
                if (startPage > 1) { controls.appendChild(createPageButton(1)); if(startPage > 2) controls.appendChild(createPageEllipsis()); }
                for (let i = startPage; i <= endPage; i++) { controls.appendChild(createPageButton(i)); }
                if (endPage < totalPages) { if(endPage < totalPages - 1) controls.appendChild(createPageEllipsis()); controls.appendChild(createPageButton(totalPages)); }
                
                const nextButton = document.createElement('button');
                nextButton.textContent = 'Sau';
                nextButton.dataset.page = 'next';
                nextButton.className = `${baseButtonClass} ${defaultText}`;
                if (currentPage === totalPages) {
                    nextButton.disabled = true;
                    nextButton.className = `${baseButtonClass} ${disabledText}`;
                }
                controls.appendChild(nextButton);
            }
            
            function createPageButton(pageNumber) {
                const baseButtonClass = "py-1.5 px-3 rounded-md border text-sm";
                const activeText = "bg-blue-600 text-white border-blue-600";
                const defaultText = "bg-white text-gray-700 hover:bg-gray-50 border-gray-300";

                const button = document.createElement('button');
                button.textContent = pageNumber;
                button.dataset.page = pageNumber;
                button.className = `${baseButtonClass} ${pageNumber === currentPage ? activeText : defaultText}`;
                return button;
            }

            function createPageEllipsis() {
                const span = document.createElement('span');
                span.textContent = '...';
                span.className = 'py-1 px-2 text-gray-500';
                return span;
            }

            function openViewModal(memberId) {
                const member = getCurrentData().find(m => m.id === memberId);
                if (!member) return;
                
                memberToPrint = { member, is213: currentTab === '213' }; 

                viewModalTitle.textContent = `Đảng viên: ${member.hoTen}`;
                
                const tuoiDoi = getTuoiDoi(member.ngaySinh);
                const partyAge = getTuoiDang(member.ngayVaoDang);
                const upcomingMedal = getUpcomingMedal(member.ngayVaoDang, member.receivedMedals) || 'Không có';
                const received = member.receivedMedals || [];
                const receivedText = received.length > 0 ? received.join(', ') + ' năm' : 'Chưa nhận';

                let donViCongTacHtml = '';
                if (currentTab === '213') {
                    donViCongTacHtml = `
                        <div class="col-span-2 bg-purple-50 p-3 rounded-md">
                            <dt class="text-sm font-medium text-purple-700">Đơn vị công tác (Nơi sinh hoạt Đảng):</dt>
                            <dd class="text-base font-semibold text-purple-900">${member.donViCongTac || 'Chưa cập nhật'}</dd>
                        </div>
                    `;
                }

                viewModalContent.innerHTML = `
                    <div>
                        <h4 class="text-sm font-bold uppercase text-gray-400 mb-3">Thông tin cá nhân</h4>
                        <dl class="grid grid-cols-2 gap-x-4 gap-y-4">
                            <div><dt class="text-sm font-medium text-gray-500">Họ tên:</dt><dd class="text-base font-semibold text-gray-900">${member.hoTen}</dd></div>
                            <div><dt class="text-sm font-medium text-gray-500">Ngày sinh (Tuổi đời):</dt><dd class="text-base font-semibold text-gray-900">${formatDate(member.ngaySinh)} (${tuoiDoi} tuổi)</dd></div>
                            ${donViCongTacHtml} 
                            <div><dt class="text-sm font-medium text-gray-500">Giới tính:</dt><dd class="text-base font-semibold text-gray-900">${member.gioiTinh}</dd></div>
                            <div><dt class="text-sm font-medium text-gray-500">Quê quán:</dt><dd class="text-base font-semibold text-gray-900">${member.queQuan || 'Chưa cập nhật'}</dd></div>
                            <div><dt class="text-sm font-medium text-gray-500">Số CCCD:</dt><dd class="text-base font-semibold text-gray-900">${member.cccd || 'Chưa cập nhật'}</dd></div>
                            <div><dt class="text-sm font-medium text-gray-500">Số điện thoại:</dt><dd class="text-base font-semibold text-gray-900">${member.soDienThoai || 'Chưa cập nhật'}</dd></div>
                            <div class="col-span-2"><dt class="text-sm font-medium text-gray-500">Số thẻ Đảng:</dt><dd class="text-base font-semibold text-gray-900">${member.soTheDang || 'Chưa cập nhật'}</dd></div>
                        </dl>
                    </div>

                    <div>
                        <h4 class="text-sm font-bold uppercase text-gray-400 mb-3">Trình độ</h4>
                        <dl class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-4">
                            <div><dt class="text-sm font-medium text-gray-500">Học vấn:</dt><dd class="text-base font-semibold text-gray-900">${member.hocVan || 'Chưa cập nhật'}</dd></div>
                            <div><dt class="text-sm font-medium text-gray-500">Lý luận Chính trị:</dt><dd class="text-base font-semibold text-gray-900">${member.chinhTri || 'Chưa cập nhật'}</dd></div>
                            <div class="col-span-1 md:col-span-2"><dt class="text-sm font-medium text-gray-500">Chuyên môn:</dt><dd class="text-base font-semibold text-gray-900">${member.chuyenMon || 'Chưa cập nhật'}</dd></div>
                        </dl>
                    </div>

                    <div>
                        <h4 class="text-sm font-bold uppercase text-gray-400 mb-3">Thông tin Đảng</h4>
                        <dl class="grid grid-cols-2 gap-x-4 gap-y-4">
                            <div><dt class="text-sm font-medium text-gray-500">Ngày vào Đảng (Dự bị):</dt><dd class="text-base font-semibold text-gray-900">${formatDate(member.ngayVaoDang)}</dd></div>
                            <div><dt class="text-sm font-medium text-gray-500">Ngày vào Đảng (Chính thức):</dt><dd class="text-base font-semibold text-gray-900">${formatDate(member.ngayChinhThuc)}</dd></div>
                            <div><dt class="text-sm font-medium text-gray-500">Tuổi Đảng (hiện tại):</dt><dd class="text-base font-semibold text-gray-900">${partyAge} năm (Tính từ ngày dự bị)</dd></div>
                            <div><dt class="text-sm font-medium text-gray-500">Huy hiệu đã nhận:</dt><dd class="text-base font-semibold text-gray-900">${receivedText}</dd></div>
                            <div class="col-span-2"><dt class="text-sm font-medium text-gray-500">Huy hiệu sắp tới (chưa nhận):</dt><dd class="text-base font-semibold text-red-600">${upcomingMedal}</dd></div>
                        </dl>
                    </div>

                    
                    <div>
                        <h4 class="text-sm font-bold uppercase text-gray-400 mb-3">Tính tuổi Đảng (các mốc)</h4>
                        
                        <div class="mb-3">
                            <label for="milestoneYearSelect" class="text-sm font-medium text-gray-700">Chọn năm tính mốc:</label>
                            <select id="milestoneYearSelect" class="w-full mt-1 p-2 border border-gray-300 rounded-md bg-gray-50"></select>
                        </div>
                        
                        <dl class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-3">
                            <div><dt class="text-sm font-medium text-gray-500" id="labelFeb3">Tại mốc 03/02/YYYY:</dt><dd class="text-base font-semibold text-gray-900" id="ageAtFeb3">-- năm</dd></div>
                            <div><dt class="text-sm font-medium text-gray-500" id="labelMay19">Tại mốc 19/05/YYYY:</dt><dd class="text-base font-semibold text-gray-900" id="ageAtMay19">-- năm</dd></div>
                            <div><dt class="text-sm font-medium text-gray-500" id="labelSep2">Tại mốc 02/09/YYYY:</dt><dd class="text-base font-semibold text-gray-900" id="ageAtSep2">-- năm</dd></div>
                            <div><dt class="text-sm font-medium text-gray-500" id="labelNov7">Tại mốc 07/11/YYYY:</dt><dd class="text-base font-semibold text-gray-900" id="ageAtNov7">-- năm</dd></div>
                        </dl>
                    </div>
                    

                    <div>
                        <h4 class="text-sm font-bold uppercase text-gray-400 mb-3">Thông tin khác</h4>
                        <dl class="grid grid-cols-2 gap-x-4 gap-y-4">
                            <div><dt class="text-sm font-medium text-gray-500">Chức vụ:</dt><dd class="text-base font-semibold text-gray-900">${member.chucVu || 'Đảng viên'}</dd></div>
                            <div><dt class="text-sm font-medium text-gray-500">Trạng thái:</dt><dd class="text-base font-semibold text-gray-900">${member.trangThai}</dd></div>
                            <div class="col-span-2"><dt class="text-sm font-medium text-gray-500">Ghi chú:</dt><dd class="text-base font-semibold text-gray-900">${member.ghiChu || 'Không có'}</dd></div>
                        </dl>
                    </div>
                `;
                
                const yearSelect = document.getElementById('milestoneYearSelect');
                if (yearSelect) {
                    const today = new Date();
                    const currentYear = today.getFullYear();
                    yearSelect.innerHTML = ''; 

                    for (let i = currentYear - 5; i <= currentYear + 4; i++) {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = i;
                        yearSelect.appendChild(option);
                    }
                    
                    yearSelect.value = currentYear; 

                    yearSelect.onchange = (e) => {
                        updateMilestoneAges(e.target.value, member.ngayVaoDang); 
                    };
                    
                    updateMilestoneAges(currentYear, member.ngayVaoDang);
                }
                
                viewModal.classList.add('show');
            }


            function updateMilestoneAges(year, ngayVaoDang) {
                if (!ngayVaoDang) return; 
                const y = parseInt(year);
                
                const dateFeb3 = new Date(y, 1, 3); 
                const dateMay19 = new Date(y, 4, 19); 
                const dateSep2 = new Date(y, 8, 2); 
                const dateNov7 = new Date(y, 10, 7);

                const ageAtFeb3 = calculateAgeAtDate(ngayVaoDang, dateFeb3);
                const ageAtMay19 = calculateAgeAtDate(ngayVaoDang, dateMay19); 
                const ageAtSep2 = calculateAgeAtDate(ngayVaoDang, dateSep2);
                const ageAtNov7 = calculateAgeAtDate(ngayVaoDang, dateNov7);
                
                if (document.getElementById('labelFeb3')) document.getElementById('labelFeb3').textContent = `Tại mốc 03/02/${y}:`;
                if (document.getElementById('ageAtFeb3')) document.getElementById('ageAtFeb3').textContent = `${ageAtFeb3} năm`;
                if (document.getElementById('labelMay19')) document.getElementById('labelMay19').textContent = `Tại mốc 19/05/${y}:`; 
                if (document.getElementById('ageAtMay19')) document.getElementById('ageAtMay19').textContent = `${ageAtMay19} năm`; 
                if (document.getElementById('labelSep2')) document.getElementById('labelSep2').textContent = `Tại mốc 02/09/${y}:`;
                if (document.getElementById('ageAtSep2')) document.getElementById('ageAtSep2').textContent = `${ageAtSep2} năm`;
                if (document.getElementById('labelNov7')) document.getElementById('labelNov7').textContent = `Tại mốc 07/11/${y}:`;
                if (document.getElementById('ageAtNov7')) document.getElementById('ageAtNov7').textContent = `${ageAtNov7} năm`;
            }

            function openModal(memberId = null) {
                memberForm.reset();
                document.querySelectorAll('#memberForm .received-medal').forEach(cb => cb.checked = false);
                
                const is213 = currentTab === '213';
                
                if (donViCongTacGroup) donViCongTacGroup.classList.toggle('hidden', !is213);
                if (medalCheckboxesGroup) medalCheckboxesGroup.classList.toggle('hidden', is213);
                
                if (currentTabInput) currentTabInput.value = currentTab;
                if (document.getElementById('donViCongTac')) document.getElementById('donViCongTac').required = is213;

                if (memberId) {
                    const member = getCurrentData().find(m => m.id === memberId);
                    modalTitle.textContent = `Chỉnh sửa thông tin Đảng viên (${is213 ? '213' : 'Chính thức'})`;
                    document.getElementById('memberId').value = member.id;
                    document.getElementById('hoTen').value = member.hoTen;
                    document.getElementById('ngaySinh').value = member.ngaySinh;
                    document.getElementById('gioiTinh').value = member.gioiTinh;
                    document.getElementById('queQuan').value = member.queQuan;
                    document.getElementById('cccd').value = member.cccd;
                    document.getElementById('soDienThoai').value = member.soDienThoai || ''; 
                    document.getElementById('soTheDang').value = member.soTheDang;
                    document.getElementById('ngayVaoDang').value = member.ngayVaoDang;
                    document.getElementById('ngayChinhThuc').value = member.ngayChinhThuc;
                    document.getElementById('hocVan').value = member.hocVan || '';
                    document.getElementById('chinhTri').value = member.chinhTri || '';
                    document.getElementById('chuyenMon').value = member.chuyenMon || '';
                    document.getElementById('chucVu').value = member.chucVu;
                    document.getElementById('trangThai').value = member.trangThai;
                    document.getElementById('ghiChu').value = member.ghiChu;
                    
                    if (is213 && document.getElementById('donViCongTac')) {
                        document.getElementById('donViCongTac').value = member.donViCongTac || ''; 
                    }

                    if (member.receivedMedals && Array.isArray(member.receivedMedals)) {
                        member.receivedMedals.forEach(medalYear => {
                            const checkbox = document.querySelector(`#memberForm .received-medal[value="${medalYear}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                } else {
                    modalTitle.textContent = `Thêm Đảng viên (${is213 ? '213' : 'Chính thức'})`;
                    document.getElementById('memberId').value = '';
                }
                memberModal.classList.add('show');
            }

            function closeModal() {
                memberModal.classList.remove('show');
                memberForm.reset();
            }

            function validateForm(data, is213) {
                const errors = [];
                const today = new Date();
                today.setHours(0, 0, 0, 0); 
                
                if (data.ngaySinh) {
                    const dob = new Date(data.ngaySinh);
                    if (dob > today) { errors.push("Lỗi: Ngày sinh không được ở tương lai."); }
                }
                if (data.ngayVaoDang && data.ngayChinhThuc) {
                    const duBiDate = new Date(data.ngayVaoDang);
                    const chinhThucDate = new Date(data.ngayChinhThuc);
                    if (chinhThucDate <= duBiDate) { errors.push("Lỗi: Ngày chính thức phải ở sau ngày dự bị."); }
                }
                if (data.soDienThoai && data.soDienThoai.trim() !== '') { 
                    const phoneRegex = /^0\d{9}$/;
                    if (!phoneRegex.test(data.soDienThoai)) { errors.push("Lỗi: Số điện thoại không hợp lệ (phải là 10 số, bắt đầu bằng 0)."); }
                }
                
                if (is213 && (!data.donViCongTac || data.donViCongTac.trim() === '')) {
                    errors.push("Lỗi: Vui lòng nhập Đơn vị công tác cho Đảng viên 213.");
                }
                
                return errors;
            }

            function handleFormSubmit(event) {
                event.preventDefault();
                
                const tabToSave = currentTabInput ? currentTabInput.value : 'main';
                const is213 = tabToSave === '213';

                const receivedCheckboxes = document.querySelectorAll('#memberForm .received-medal:checked');
                const receivedMedals = Array.from(receivedCheckboxes).map(cb => parseInt(cb.value)).filter(Number.isInteger);

                const memberData = {
                    hoTen: document.getElementById('hoTen').value,
                    ngaySinh: document.getElementById('ngaySinh').value,
                    gioiTinh: document.getElementById('gioiTinh').value,
                    queQuan: document.getElementById('queQuan').value,
                    cccd: document.getElementById('cccd').value,
                    soDienThoai: document.getElementById('soDienThoai').value, 
                    soTheDang: document.getElementById('soTheDang').value,
                    ngayVaoDang: document.getElementById('ngayVaoDang').value,
                    ngayChinhThuc: document.getElementById('ngayChinhThuc').value,
                    hocVan: document.getElementById('hocVan').value,
                    chinhTri: document.getElementById('chinhTri').value,
                    chuyenMon: document.getElementById('chuyenMon').value,
                    chucVu: document.getElementById('chucVu').value,
                    trangThai: document.getElementById('trangThai').value,
                    ghiChu: document.getElementById('ghiChu').value,
                    receivedMedals: receivedMedals, 
                };
                
                if (is213) {
                    memberData.donViCongTac = document.getElementById('donViCongTac').value;
                }

                let currentMembers = tabToSave === 'main' ? members : members213;

                const validationErrors = validateForm(memberData, is213);
                if (validationErrors.length > 0) {
                    alert("Không thể lưu! Vui lòng kiểm tra lại các lỗi sau:\n\n" + validationErrors.join("\n"));
                    return; 
                }

                const memberId = document.getElementById('memberId').value;

                if (memberId) {
                    const index = currentMembers.findIndex(m => m.id === parseInt(memberId));
                    currentMembers[index] = { ...currentMembers[index], ...memberData };
                } else {
                    const newId = currentMembers.length > 0 ? Math.max(...currentMembers.map(m => m.id)) + 1 : 1;
                    currentMembers.push({ id: newId, ...memberData });
                }

                if (tabToSave === 'main') {
                    members = currentMembers;
                } else {
                    members213 = currentMembers;
                }
                
                saveToLocalStorage();
                applyFiltersAndRender();
                closeModal();
            }

            function handleLoginAttempt() {
                const password = passwordInput ? passwordInput.value : '';
                if (!password) { alert("Vui lòng nhập mật khẩu."); return; }
                
                appKey = password;
                
                try {
                    loadFromLocalStorage(); 
                } catch (e) {
                     alert("Mật khẩu không đúng! Vui lòng thử lại.");
                     appKey = null; 
                     if(passwordInput) passwordInput.value = ""; 
                     return;
                }
                
                if (authModal) authModal.classList.remove('show');
                if (appContainer) appContainer.classList.add('unlocked');
                
                switchTab('main');
                
                const encryptedData = localStorage.getItem('partyMembers_encrypted');
                if (members.length === 0 && members213.length === 0 && !encryptedData) { 
                    setTimeout(() => {
                        if(helpModal) helpModal.classList.add('show');
                    }, 500); 
                }
            }
            
            function switchTab(tabId) {
                currentTab = tabId;
                currentPage = 1;
                
                if (mainMemberContainer) mainMemberContainer.classList.toggle('active', tabId === 'main');
                if (member213Container) member213Container.classList.toggle('active', tabId === '213');
                
                document.querySelectorAll('.tab-button').forEach(button => {
                    const isActive = button.dataset.tab === tabId;
                    button.classList.toggle('border-red-700', isActive && tabId === 'main');
                    button.classList.toggle('text-red-700', isActive && tabId === 'main');
                    button.classList.toggle('bg-red-50', isActive && tabId === 'main');
                    button.classList.toggle('border-purple-700', isActive && tabId === '213');
                    button.classList.toggle('text-purple-700', isActive && tabId === '213');
                    button.classList.toggle('bg-purple-50', isActive && tabId === '213');

                    button.classList.toggle('border-transparent', !isActive);
                    button.classList.toggle('text-gray-500', !isActive);
                    button.classList.toggle('hover:text-red-700', !isActive);
                    button.classList.toggle('hover:border-red-500', !isActive);
                });
                
                const filterDom = tabId === 'main' ? filterMenu : filterMenu213;
                if (filterDom) filterDom.classList.remove('show');
                
                if (tabId === 'main') {
                    const sortInput = document.querySelector('input[name="sort"]:checked');
                    if (sortInput) currentSort = sortInput.value;
                    const genderInput = document.querySelector('input[name="gender"]:checked');
                    if (genderInput) currentGenderFilter = genderInput.value;
                    const medalInput = document.querySelector('input[name="medal"]:checked');
                    if (medalInput) currentMedalFilter = medalInput.value;
                } else {
                    const sortInput = document.querySelector('input[name="sort213"]:checked');
                    if (sortInput) currentSort = sortInput.value;
                    const genderInput = document.querySelector('input[name="gender213"]:checked');
                    if (genderInput) currentGenderFilter = genderInput.value;
                    const medalInput = document.querySelector('input[name="medal213"]:checked');
                    if (medalInput) currentMedalFilter = medalInput.value;
                }

                applyFiltersAndRender();
            }

            function initializeForm() {
                ALL_MILESTONES.forEach(year => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-2 text-sm cursor-pointer';
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.className = 'received-medal form-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500';
                    input.value = year;
                    label.appendChild(input);
                    label.appendChild(document.createTextNode(` ${year} năm`));
                    if(receivedMedalCheckboxes) receivedMedalCheckboxes.appendChild(label);
                });
            }

            function updateBulkDeleteButtonState() {
                const currentTableBody = currentTab === 'main' ? memberTableBody : member213TableBody;
                const bulkDeleteDom = currentTab === 'main' ? bulkDeleteBtn : bulkDelete213Btn;
                const countSpan = currentTab === 'main' ? document.getElementById('bulkDeleteCount') : document.getElementById('bulkDelete213Count');
                const selectAllDom = currentTab === 'main' ? selectAllCheckbox : selectAll213Checkbox;
                
                if (!currentTableBody || !bulkDeleteDom || !countSpan || !selectAllDom) return;

                const selectedCheckboxes = currentTableBody.querySelectorAll(`.member-checkbox[data-tab="${currentTab}"]:checked`);
                const selectedCount = selectedCheckboxes.length;
                
                if (selectedCount > 0) {
                    bulkDeleteDom.classList.remove('hidden'); 
                    countSpan.textContent = `(${selectedCount})`;
                } else {
                    bulkDeleteDom.classList.add('hidden'); 
                    countSpan.textContent = `(0)`;
                }

                const totalCheckboxes = currentTableBody.querySelectorAll(`.member-checkbox[data-tab="${currentTab}"]`).length;
                selectAllDom.checked = (totalCheckboxes > 0 && selectedCount === totalCheckboxes);
            }

            function openDeleteModal(id, tab) {
                const data = tab === 'main' ? members : members213;
                const member = data.find(m => m.id === id);
                if (!member) return;
                
                itemToDelete = { id, tab }; 
                if (deleteModalTitle) deleteModalTitle.textContent = `Xóa Đảng viên (${tab === '213' ? '213' : 'Chính thức'})`;
                if (deleteModalBody) deleteModalBody.innerHTML = `Bạn có chắc chắn muốn xóa Đảng viên: <br><strong class="font-medium text-gray-900">${member.hoTen}</strong>? <br>Hành động này không thể hoàn tác.`;
                if (deleteModal) deleteModal.classList.add('show');
            }

            function openBulkDeleteModal() {
                const currentTableBody = currentTab === 'main' ? memberTableBody : member213TableBody;
                const selectedCheckboxes = currentTableBody.querySelectorAll('.member-checkbox[data-tab="' + currentTab + '"]:checked');
                const selectedIds = Array.from(selectedCheckboxes).map(cb => parseInt(cb.dataset.id));
                
                if (selectedIds.length === 0) { alert('Bạn chưa chọn mục nào để xóa.'); return; }
                
                itemToDelete = { id: selectedIds, tab: currentTab }; 
                if (deleteModalTitle) deleteModalTitle.textContent = `Xóa hàng loạt (${currentTab === '213' ? '213' : 'Chính thức'})`;
                if (deleteModalBody) deleteModalBody.innerHTML = `Bạn có chắc chắn muốn xóa <strong class="font-medium text-gray-900">${selectedIds.length}</strong> Đảng viên đã chọn? <br>Hành động này không thể hoàn tác.`;
                if (deleteModal) deleteModal.classList.add('show');
            }
            
            function handleConfirmDelete() {
                if (!itemToDelete || !itemToDelete.tab) return; 

                let currentMembers = itemToDelete.tab === 'main' ? members : members213;
                let idsToDelete = Array.isArray(itemToDelete.id) ? itemToDelete.id : [itemToDelete.id];

                currentMembers = currentMembers.filter(member => !idsToDelete.includes(member.id));
                
                if (itemToDelete.tab === 'main') {
                    members = currentMembers;
                } else {
                    members213 = currentMembers;
                }
                
                saveToLocalStorage();
                applyFiltersAndRender();
                if (deleteModal) deleteModal.classList.remove('show');
            }
            
            function escapeCSV(str) {
                if (str === null || str === undefined) return ''; 
                const strString = String(str); 
                if (strString.includes(',') || strString.includes('\n') || strString.includes('"')) {
                    return `"${strString.replace(/"/g, '""')}"`;
                }
                return strString;
            }

            function downloadFile(content, fileName, mimeType) {
                const bom = "\uFEFF"; 
                const dataBlob = new Blob([bom + content], { type: mimeType });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', fileName);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function exportData(tab = 'main') {
                if (!appKey) { alert("Vui lòng đăng nhập lại để thực hiện!"); return; }
                const encryptedData = localStorage.getItem(tab === 'main' ? 'partyMembers_encrypted' : 'partyMembers213_encrypted');
                if (!encryptedData) { alert('Không tìm thấy dữ liệu đã mã hoá. Vui lòng thêm/sửa một Đảng viên để khởi tạo lại.'); return; }
                
                const filename = tab === 'main' ? 'backup_dangvien_chinhthuc' : 'backup_dangvien_213';
                const dataBlob = new Blob([encryptedData], { type: 'text/plain;charset=utf-8' }); 
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', `${filename}_encrypted_${new Date().toISOString().slice(0,10)}.json.txt`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function importData(event, tab = 'main') {
                if (!appKey) { alert("Vui lòng đăng nhập lại để thực hiện!"); return; }
                
                const file = event.target.files[0];
                if (!file) return;

                if (!confirm(`Việc này sẽ GHI ĐÈ toàn bộ dữ liệu Đảng viên ${tab === 'main' ? 'CHÍNH THỨC' : '213'} hiện tại. Bạn có chắc chắn muốn tiếp tục?`)) {
                    event.target.value = null; return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    let decryptedData = "";
                    const fileContent = e.target.result;
                    
                    try {
                        const decryptedBytes = CryptoJS.AES.decrypt(fileContent, appKey);
                        decryptedData = decryptedBytes.toString(CryptoJS.enc.Utf8);
                    } catch (e) {
                        decryptedData = fileContent;
                    }

                    try {
                        if (!decryptedData) throw new Error("Giải mã thất bại - Sai mật khẩu hoặc tệp lỗi?");

                        const importedMembers = JSON.parse(decryptedData);
                        
                        if (Array.isArray(importedMembers)) {
                            if (tab === 'main') {
                                members = importedMembers;
                            } else {
                                members213 = importedMembers;
                            }
                            saveToLocalStorage(); 
                            switchTab(currentTab); 
                            alert(`Nhập và khôi phục dữ liệu Đảng viên ${tab === 'main' ? 'Chính thức' : '213'} thành công!`);
                        } else {
                            alert('Tệp JSON không hợp lệ sau khi giải mã.');
                        }
                    } catch (error) {
                        alert('Lỗi khi đọc tệp: ' + error.message);
                    }
                    event.target.value = null;
                };
                reader.readAsText(file);
            }
            
            function downloadCsvTemplate(is213 = false) {
                const commonHeaders = ['Họ tên', 'Ngày sinh (DD/MM/YYYY)', 'Giới tính (Nam/Nữ)', 'Quê quán'];
                let headers = [...commonHeaders];
                if (is213) { headers.push('Đơn vị công tác'); }
                headers.push('Số CCCD', 'Số điện thoại', 'Số thẻ Đảng viên', 'Ngày vào Đảng (DD/MM/YYYY)', 'Ngày chính thức (DD/MM/YYYY)', 'Chức vụ', 'Trạng thái', 'Ghi chú', 'Học vấn', 'Chính trị', 'Chuyên môn', 'Huy hiệu đã nhận (cách nhau bằng ;)');

                let csvContent = headers.map(escapeCSV).join(',') + '\n';
                
                let example;
                if (is213) {
                    example = [
                        'Trần Thị B', '10/05/1985', 'Nữ', 'TP.HCM', 
                        'Công an Q.1/Chi bộ 1', 
                        '002987654321', '0912345678', 
                        '87654321', '01/01/2008', '01/01/2009',
                        'Đảng viên', 'Đang sinh hoạt', 'Ghi chú 213',
                        'Đại học', 'Trung cấp', 'Thạc sĩ Luật',
                        '30;40'
                    ];
                } else {
                    example = [
                        'Nguyễn Văn A', '01/01/1990', 'Nam', 'Hà Nội', 
                        '001234567890', 
                        '0901234567', 
                        '12345678', '01/01/2020', '01/01/2021', 
                        'Đảng viên', 'Đang sinh hoạt', 'Ghi chú ví dụ',
                        '12/12', 'Cao cấp', 'Kỹ sư CNTT',
                        '30;40'
                    ];
                }

                csvContent += example.map(escapeCSV).join(',') + '\n';

                downloadFile(csvContent, `template_nhap_lieu_${is213 ? '213' : 'chinhthuc'}.csv`, 'text/csv;charset=utf-8;');
            }
            
            function exportToCSV(tab = 'main') {
                try {
                    const data = tab === 'main' ? members : members213;
                    if (data.length === 0) { alert(`Không có dữ liệu Đảng viên ${tab === 'main' ? 'Chính thức' : '213'} để xuất CSV.`); return; }
                    
                    const commonHeaders = ['ID', 'Họ tên', 'Ngày sinh (DD/MM/YYYY)', 'Giới tính', 'Quê quán'];
                    let headers = [...commonHeaders];
                    if (tab === '213') { headers.push('Đơn vị công tác'); }
                    const tailHeaders = ['Số CCCD', 'Số điện thoại', 'Số thẻ Đảng viên', 'Ngày vào Đảng (DD/MM/YYYY)', 'Ngày chính thức (DD/MM/YYYY)', 'Chức vụ', 'Trạng thái', 'Ghi chú', 'Học vấn', 'Chính trị', 'Chuyên môn', 'Huy hiệu đã nhận'];
                    headers.push(...tailHeaders);
                    
                    let csvContent = headers.map(escapeCSV).join(',') + '\n';

                    data.forEach(m => {
                        let row = [
                            m.id, m.hoTen, formatDate(m.ngaySinh), m.gioiTinh, m.queQuan
                        ];
                        if (tab === '213') {
                            row.push(m.donViCongTac);
                        }
                        row.push(
                            m.cccd, m.soDienThoai, m.soTheDang, formatDate(m.ngayVaoDang), formatDate(m.ngayChinhThuc),
                            m.chucVu, m.trangThai, m.ghiChu, m.hocVan, m.chinhTri, m.chuyenMon,
                            (m.receivedMedals || []).join(';') 
                        );
                        csvContent += row.map(escapeCSV).join(',') + '\n';
                    });

                    downloadFile(csvContent, `danhsach_dangvien_${tab === 'main' ? 'chinhthuc' : '213'}_${new Date().toISOString().slice(0,10)}.csv`, 'text/csv;charset=utf-8;');
                } catch (error) {
                    alert('LỖI XUẤT CSV: Đã xảy ra lỗi. Vui lòng thử lại. Lỗi: ' + error.message);
                }
            }

            function importFromCSV(event, is213 = false) {
                const file = event.target.files[0];
                if (!file) return;

                if (!confirm(`Việc này sẽ *THÊM* dữ liệu từ file CSV vào danh sách Đảng viên ${is213 ? '213' : 'Chính thức'} hiện tại. Bạn có chắc chắn?`)) {
                    event.target.value = null; return;
                }

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split('\n');
                        
                        if (lines.length <= 1) { alert('Tệp CSV trống hoặc không hợp lệ.'); return; }

                        let currentMembers = is213 ? members213 : members;
                        let maxId = currentMembers.length > 0 ? Math.max(...currentMembers.map(m => m.id)) : 0;
                        let addedCount = 0;
                        
                        const requiredCols = is213 ? 17 : 16; 

                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (line === '') continue; 

                            const values = line.split(','); 
                            
                            if (values.length < requiredCols) {
                                console.warn(`Bỏ qua dòng ${i+1}: Không đủ ${requiredCols} cột. (Tìm thấy ${values.length})`);
                                continue; 
                            }
                            
                            const donViCongTacIndex = is213 ? 4 : -1;
                            const cccdIndex = is213 ? 5 : 4;
                            const soDienThoaiIndex = is213 ? 6 : 5;
                            const soTheDangIndex = is213 ? 7 : 6;
                            const ngayVaoDangIndex = is213 ? 8 : 7;
                            const ngayChinhThucIndex = is213 ? 9 : 8;
                            const chucVuIndex = is213 ? 10 : 9;
                            const trangThaiIndex = is213 ? 11 : 10;
                            const ghiChuIndex = is213 ? 12 : 11;
                            const hocVanIndex = is213 ? 13 : 12;
                            const chinhTriIndex = is213 ? 14 : 13;
                            const chuyenMonIndex = is213 ? 15 : 14;
                            const medalIndex = is213 ? 16 : 15;
                            
                            const receivedString = values[medalIndex].trim().replace(/"/g, ''); 
                            const receivedMedals = receivedString === '' ? [] : receivedString.split(';').map(s => parseInt(s.trim())).filter(Number.isInteger);

                            let memberData = {
                                hoTen: values[0].trim(),
                                ngaySinh: normalizeDate(values[1].trim()),
                                gioiTinh: values[2].trim(),
                                queQuan: values[3].trim(),
                                cccd: values[cccdIndex].trim(),
                                soDienThoai: values[soDienThoaiIndex].trim(), 
                                soTheDang: values[soTheDangIndex].trim(),
                                ngayVaoDang: normalizeDate(values[ngayVaoDangIndex].trim()),
                                ngayChinhThuc: normalizeDate(values[ngayChinhThucIndex].trim()),
                                chucVu: values[chucVuIndex].trim(),
                                trangThai: values[trangThaiIndex].trim(),
                                ghiChu: values[ghiChuIndex].trim(),
                                hocVan: values[hocVanIndex].trim(),
                                chinhTri: values[chinhTriIndex].trim(),
                                chuyenMon: values[chuyenMonIndex].trim(),
                                receivedMedals: receivedMedals 
                            };

                            if (is213) {
                                memberData.donViCongTac = values[donViCongTacIndex].trim();
                            }

                            if (!memberData.hoTen || !memberData.ngaySinh || !memberData.ngayVaoDang) { 
                                console.warn(`Bỏ qua dòng ${i+1}: Thiếu Họ tên, Ngày sinh hoặc Ngày vào Đảng (Dự bị).`);
                                continue;
                            }

                            maxId++;
                            currentMembers.push({ id: maxId, ...memberData });
                            addedCount++;
                        }

                        if (is213) {
                            members213 = currentMembers;
                        } else {
                            members = currentMembers;
                        }

                        saveToLocalStorage();
                        switchTab(currentTab); 
                        alert(`Đã thêm thành công ${addedCount} Đảng viên ${is213 ? '213' : 'Chính thức'} từ tệp CSV.`);
                    } catch (error) {
                        alert('Lỗi khi đọc tệp CSV: ' + error.message);
                    }
                    event.target.value = null; 
                };
                reader.readAsText(file, 'UTF-8'); 
            }
            
            // --- THỐNG KÊ CHI TIẾT (ĐÃ THÊM LẠI LOGIC ĐẦY ĐỦ) ---
            function openStatsModal(tab = 'main') {
                const data = tab === 'main' ? members : members213;
                if (data.length === 0) {
                    if(statsModalContent) statsModalContent.innerHTML = '<p class="text-center text-gray-500">Chưa có dữ liệu để thống kê.</p>';
                    if(statsModal) statsModal.classList.add('show');
                    return;
                }

                // 1. Thống kê Tuổi Đảng
                const ageGroups = { '0-10 năm': 0, '11-20 năm': 0, '21-30 năm': 0, '31-40 năm': 0, '41-50 năm': 0, '51+ năm': 0 };
                data.forEach(m => {
                    const age = getTuoiDang(m.ngayVaoDang);
                    if (age <= 10) ageGroups['0-10 năm']++;
                    else if (age <= 20) ageGroups['11-20 năm']++;
                    else if (age <= 30) ageGroups['21-30 năm']++;
                    else if (age <= 40) ageGroups['31-40 năm']++;
                    else if (age <= 50) ageGroups['41-50 năm']++;
                    else ageGroups['51+ năm']++;
                });

                // 2. Thống kê Trạng thái
                const statusGroups = { 'Đang sinh hoạt': 0, 'Miễn sinh hoạt': 0, 'Chuyển đi': 0, 'Đã qua đời': 0, 'Khác': 0 };
                data.forEach(m => {
                    const status = m.trangThai;
                    if (statusGroups.hasOwnProperty(status)) {
                        statusGroups[status]++;
                    } else {
                        statusGroups['Khác']++;
                    }
                });
                
                // Hàm helper tạo thanh bar
                const createBar = (label, count, total, colorClass) => {
                    const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                    if (count === 0) return ''; 
                    
                    return `
                        <div class="space-y-1">
                            <div class="flex justify-between text-sm font-medium">
                                <span class="text-gray-700">${label}</span>
                                <span class="text-gray-500">${count} ĐV (${percentage}%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="${colorClass} h-2.5 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                };

                // 3. Render HTML
                let statsHtml = `
                    <h3 class="text-2xl text-center leading-6 font-bold text-gray-900 mb-6">📊 Thống kê Báo cáo Nhanh ${tab === '213' ? 'Đảng viên 213' : 'Đảng viên Chính thức'}</h3>
                    <div>
                        <h4 class="text-lg font-bold text-gray-900 mb-3">Phân bổ Tuổi Đảng (Tổng: ${data.length})</h4>
                        <div class="space-y-4">
                            ${createBar('0-10 năm', ageGroups['0-10 năm'], data.length, 'bg-blue-600')}
                            ${createBar('11-20 năm', ageGroups['11-20 năm'], data.length, 'bg-blue-500')}
                            ${createBar('21-30 năm', ageGroups['21-30 năm'], data.length, 'bg-blue-400')}
                            ${createBar('31-40 năm', ageGroups['31-40 năm'], data.length, 'bg-cyan-500')}
                            ${createBar('41-50 năm', ageGroups['41-50 năm'], data.length, 'bg-cyan-400')}
                            ${createBar('51+ năm', ageGroups['51+ năm'], data.length, 'bg-cyan-300')}
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h4 class="text-lg font-bold text-gray-900 mb-3">Phân bổ Trạng thái (Tổng: ${data.length})</h4>
                        <div class="space-y-4">
                            ${createBar('Đang sinh hoạt', statusGroups['Đang sinh hoạt'], data.length, 'bg-green-500')}
                            ${createBar('Miễn sinh hoạt', statusGroups['Miễn sinh hoạt'], data.length, 'bg-yellow-500')}
                            ${createBar('Chuyển đi', statusGroups['Chuyển đi'], data.length, 'bg-indigo-500')}
                            ${createBar('Đã qua đời', statusGroups['Đã qua đời'], data.length, 'bg-gray-500')}
                            ${statusGroups['Khác'] > 0 ? createBar('Khác', statusGroups['Khác'], data.length, 'bg-red-500') : ''}
                        </div>
                    </div>
                `;

                if(statsModalContent) statsModalContent.innerHTML = statsHtml;
                if(statsModal) statsModal.classList.add('show');
            }


            // =================================================================================
            // --- 5. GÁN SỰ KIỆN (ĐÃ FIX LỖI `null` và `ReferenceError`) ---
            // =================================================================================
            
            if (loginBtn) loginBtn.addEventListener('click', handleLoginAttempt);
            if (passwordInput) passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') { handleLoginAttempt(); }
            });

            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => switchTab(button.dataset.tab));
            });

            if (addMemberBtn) addMemberBtn.addEventListener('click', () => openModal());
            if (searchInput) searchInput.addEventListener('input', () => { currentPage = 1; applyFiltersAndRender(); });
            if (itemsPerPageSelect) itemsPerPageSelect.addEventListener('change', () => { currentPage = 1; applyFiltersAndRender(); });
            if (exportBtn) exportBtn.addEventListener('click', () => exportData('main'));
            if (importInput) importInput.addEventListener('change', (e) => importData(e, 'main'));
            if (downloadCsvTemplateBtn) downloadCsvTemplateBtn.addEventListener('click', () => downloadCsvTemplate(false));
            if (importCsvInput) importCsvInput.addEventListener('change', (e) => importFromCSV(e, false));
            if (exportCsvBtn) exportCsvBtn.addEventListener('click', () => exportToCSV('main'));
            if (selectAllCheckbox) selectAllCheckbox.addEventListener('change', (e) => handleSelectAll(e, 'main'));
            if (bulkDeleteBtn) bulkDeleteBtn.addEventListener('click', openBulkDeleteModal);
            if (statsBtn) statsBtn.addEventListener('click', () => openStatsModal('main'));
            
            if (filterMenuBtn) filterMenuBtn.addEventListener('click', (e) => { e.stopPropagation(); if(filterMenu) filterMenu.classList.toggle('show'); });
            if (filterMenu) filterMenu.addEventListener('change', (e) => {
                if (e.target.name === 'sort') { currentSort = e.target.value; }
                if (e.target.name === 'gender') { currentGenderFilter = e.target.value; }
                if (e.target.name === 'medal') { currentMedalFilter = e.target.value; }
                currentPage = 1; applyFiltersAndRender();
            });

            // GÁN SỰ KIỆN TAB 213 (ĐÃ FIX LỖI NULL VÀ CSS TOGGLE)
            if (addMember213Btn) addMember213Btn.addEventListener('click', () => openModal());
            if (searchInput213) searchInput213.addEventListener('input', () => { currentPage = 1; applyFiltersAndRender(); });
            if (itemsPerPage213Select) itemsPerPage213Select.addEventListener('change', () => { currentPage = 1; applyFiltersAndRender(); });
            if (export213Btn) export213Btn.addEventListener('click', () => exportData('213'));
            if (import213Input) import213Input.addEventListener('change', (e) => importData(e, '213'));
            if (downloadCsvTemplate213Btn) downloadCsvTemplate213Btn.addEventListener('click', () => downloadCsvTemplate(true));
            if (importCsv213Input) importCsv213Input.addEventListener('change', (e) => importFromCSV(e, true));
            if (exportCsv213Btn) exportCsv213Btn.addEventListener('click', () => exportToCSV('213'));
            if (selectAll213Checkbox) selectAll213Checkbox.addEventListener('change', (e) => handleSelectAll(e, '213'));
            if (bulkDelete213Btn) bulkDelete213Btn.addEventListener('click', openBulkDeleteModal);
            if (stats213Btn) stats213Btn.addEventListener('click', () => openStatsModal('213'));
            
            if (filterMenu213Btn && filterMenu213) {
                // FIX: Sử dụng toggle('show') và !important để đảm bảo hiển thị
                filterMenu213Btn.addEventListener('click', (e) => { e.stopPropagation(); filterMenu213.classList.toggle('show'); });
                filterMenu213.addEventListener('change', (e) => {
                    if (e.target.name === 'sort213') { currentSort = e.target.value; }
                    if (e.target.name === 'gender213') { currentGenderFilter = e.target.value; }
                    if (e.target.name === 'medal213') { currentMedalFilter = e.target.value; }
                    currentPage = 1; applyFiltersAndRender();
                });
            }

            // GÁN SỰ KIỆN ĐỔI MẬT KHẨU (MỚI)
            if (changePasswordBtn) changePasswordBtn.addEventListener('click', openChangePasswordModal);
            if (cancelChangePasswordBtn) cancelChangePasswordBtn.addEventListener('click', closeChangePasswordModal);
            if (changePasswordForm) changePasswordForm.addEventListener('submit', handleChangePasswordSubmit);


            // Xử lý Select All (dùng chung cho cả 2 tab)
            function handleSelectAll(event, tab) {
                const isChecked = event.target.checked;
                const currentTableBody = tab === 'main' ? memberTableBody : member213TableBody;
                if (!currentTableBody) return;
                const allCheckboxes = currentTableBody.querySelectorAll(`.member-checkbox[data-tab="${tab}"]`);
                allCheckboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
                updateBulkDeleteButtonState();
            }

            // Xử lý sự kiện chung (Delegate events)
            document.body.addEventListener('click', (event) => {
                const target = event.target;
                if (target.closest('.view-btn')) {
                    const btn = target.closest('.view-btn');
                    const id = parseInt(btn.dataset.id);
                    openViewModal(id);
                }
                if (target.closest('.edit-btn')) {
                    const btn = target.closest('.edit-btn');
                    const id = parseInt(btn.dataset.id);
                    openModal(id);
                }
                if (target.closest('.delete-btn')) {
                    const btn = target.closest('.delete-btn');
                    const id = parseInt(btn.dataset.id);
                    const tab = btn.dataset.tab;
                    openDeleteModal(id, tab);
                }
                if (target.closest('.member-checkbox')) {
                    updateBulkDeleteButtonState();
                }
                if (target.closest('.tab-button')) {
                    // Đóng menu lọc khi chuyển tab
                    if (filterMenu) filterMenu.classList.remove('show');
                    if (filterMenu213) filterMenu213.classList.remove('show');
                }
                
                // Đóng menu lọc khi click ra ngoài (để ngoài DOMContentLoaded)
                if (filterMenu && filterMenu.classList.contains('show') && !filterMenu.contains(target) && !filterMenuBtn.contains(target)) {
                    filterMenu.classList.remove('show');
                }
                if (filterMenu213 && filterMenu213.classList.contains('show') && !filterMenu213.contains(target) && !filterMenu213Btn.contains(target)) {
                    filterMenu213.classList.remove('show');
                }
            });
            
            // Xử lý Pagination
            document.getElementById('appContainer').addEventListener('click', (event) => {
                const target = event.target.closest('#paginationControls button, #pagination213Controls button');
                if (!target) return; 

                const action = target.dataset.page;
                let pageChanged = false;

                if (action === 'prev' && currentPage > 1) { currentPage--; pageChanged = true; } 
                else if (action === 'next' && currentPage < totalPages) { currentPage++; pageChanged = true; } 
                else if (!isNaN(action)) {
                    const newPage = parseInt(action);
                    if (newPage !== currentPage) { currentPage = newPage; pageChanged = true; }
                }
                if (pageChanged) { applyFiltersAndRender(); }
            });
            
            if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
            if (memberForm) memberForm.addEventListener('submit', handleFormSubmit);
            if (document.getElementById('closeViewModalBtn')) document.getElementById('closeViewModalBtn').addEventListener('click', () => viewModal.classList.remove('show'));
            if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', () => deleteModal.classList.remove('show'));
            if (confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', handleConfirmDelete);
            if (closeHelpModalBtn) closeHelpModalBtn.addEventListener('click', () => helpModal.classList.remove('show'));
            if (document.getElementById('closeStatsModalBtn')) document.getElementById('closeStatsModalBtn').addEventListener('click', () => statsModal.classList.remove('show'));
            

            // --- KHỞI CHẠY ỨNG DỤNG ---
            initializeForm(); 
            if (authModal) authModal.classList.add('show');
            if (passwordInput) passwordInput.focus();
        });
    </script>
</body>
</html>